<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/baby.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/baby.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/baby.png">
  <link rel="mask-icon" href="/images/baby.png" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Palatino:300,300italic,400,400italic,700,700italic|Monaco:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"thesong96.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="TheSong is named after IG.TheShy">
<meta property="og:type" content="website">
<meta property="og:title" content="TheSong">
<meta property="og:url" content="https://thesong96.github.io/index.html">
<meta property="og:site_name" content="TheSong">
<meta property="og:description" content="TheSong is named after IG.TheShy">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Nansong Yi">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://thesong96.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>TheSong</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/rss.xml" title="TheSong" type="application/rss+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">TheSong</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://thesong96.github.io/2021/10/13/coding-interview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/baby.png">
      <meta itemprop="name" content="Nansong Yi">
      <meta itemprop="description" content="TheSong is named after IG.TheShy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TheSong">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/13/coding-interview/" class="post-title-link" itemprop="url">coding interview</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-10-13 19:43:53" itemprop="dateCreated datePublished" datetime="2021-10-13T19:43:53-07:00">2021-10-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-10-14 01:08:48" itemprop="dateModified" datetime="2021-10-14T01:08:48-07:00">2021-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/interview/" itemprop="url" rel="index"><span itemprop="name">interview</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="making-a-large-island">827. Making A Large Island</h2>
<p>https://leetcode.com/problems/making-a-large-island/</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">largestIsland</span><span class="params">(self, grid)</span>:</span></span><br><span class="line">        N = len(grid)</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">neighbors</span><span class="params">(r, c)</span>:</span></span><br><span class="line">            <span class="keyword">for</span> nr, nc <span class="keyword">in</span> ((r<span class="number">-1</span>, c), (r+<span class="number">1</span>, c), (r, c<span class="number">-1</span>), (r, c+<span class="number">1</span>)):</span><br><span class="line">                <span class="keyword">if</span> <span class="number">0</span> &lt;= nr &lt; N <span class="keyword">and</span> <span class="number">0</span> &lt;= nc &lt; N:</span><br><span class="line">                    <span class="keyword">yield</span> nr, nc</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">dfs</span><span class="params">(r, c, index)</span>:</span></span><br><span class="line">            ans = <span class="number">1</span></span><br><span class="line">            grid[r][c] = index</span><br><span class="line">            <span class="keyword">for</span> nr, nc <span class="keyword">in</span> neighbors(r, c):</span><br><span class="line">                <span class="keyword">if</span> grid[nr][nc] == <span class="number">1</span>:</span><br><span class="line">                    ans += dfs(nr, nc, index)</span><br><span class="line">            <span class="keyword">return</span> ans</span><br><span class="line"></span><br><span class="line">        area = &#123;&#125;</span><br><span class="line">        index = <span class="number">2</span></span><br><span class="line">        <span class="keyword">for</span> r <span class="keyword">in</span> range(N):</span><br><span class="line">            <span class="keyword">for</span> c <span class="keyword">in</span> range(N):</span><br><span class="line">                <span class="keyword">if</span> grid[r][c] == <span class="number">1</span>:</span><br><span class="line">                    area[index] = dfs(r, c, index)</span><br><span class="line">                    index += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        ans = max(area.values() <span class="keyword">or</span> [<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">for</span> r <span class="keyword">in</span> range(N):</span><br><span class="line">            <span class="keyword">for</span> c <span class="keyword">in</span> range(N):</span><br><span class="line">                <span class="keyword">if</span> grid[r][c] == <span class="number">0</span>:</span><br><span class="line">                    seen = &#123;grid[nr][nc] <span class="keyword">for</span> nr, nc <span class="keyword">in</span> neighbors(r, c) <span class="keyword">if</span> grid[nr][nc] &gt; <span class="number">1</span>&#125;</span><br><span class="line">                    ans = max(ans, <span class="number">1</span> + sum(area[i] <span class="keyword">for</span> i <span class="keyword">in</span> seen))</span><br><span class="line">        <span class="keyword">return</span> ans</span><br></pre></td></tr></table></figure>
<h2 id="shortest-distance-from-all-buildings">317. Shortest Distance from All Buildings</h2>
<p>https://leetcode.com/problems/shortest-distance-from-all-buildings/</p>
<figure>
<img src="https://i.imgur.com/Ud1oI3V.jpg" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">public:</span><br><span class="line">    int shortestDistance(vector&lt;vector&lt;int&gt;&gt;&amp; grid) &#123;</span><br><span class="line">        // Next four directions.</span><br><span class="line">        int dirs[<span class="number">4</span>][<span class="number">2</span>] = &#123;&#123;<span class="number">1</span>, <span class="number">0</span>&#125;, &#123;<span class="number">-1</span>, <span class="number">0</span>&#125;, &#123;<span class="number">0</span>, <span class="number">1</span>&#125;, &#123;<span class="number">0</span>, <span class="number">-1</span>&#125;&#125;;</span><br><span class="line">        </span><br><span class="line">        int rows = grid.size();</span><br><span class="line">        int cols = grid[<span class="number">0</span>].size();</span><br><span class="line">        </span><br><span class="line">        // Total Mtrix to store total distance sum <span class="keyword">for</span> each empty cell.</span><br><span class="line">        vector&lt;vector&lt;int&gt;&gt; total(rows, vector&lt;int&gt; (cols, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">        int emptyLandValue = <span class="number">0</span>;</span><br><span class="line">        int minDist = INT_MAX;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (int row = <span class="number">0</span>; row &lt; rows; ++row) &#123;</span><br><span class="line">            <span class="keyword">for</span> (int col = <span class="number">0</span>; col &lt; cols; ++col) &#123;</span><br><span class="line"></span><br><span class="line">                // Start a bfs <span class="keyword">from</span> each house.</span><br><span class="line">                <span class="keyword">if</span> (grid[row][col] == <span class="number">1</span>) &#123;</span><br><span class="line">                    minDist = INT_MAX;</span><br><span class="line"></span><br><span class="line">                    // Use a queue to perform a BFS, starting <span class="keyword">from</span> the cell located at (row, col).</span><br><span class="line">                    queue&lt;pair&lt;int, int&gt;&gt; q;</span><br><span class="line">                    q.push(&#123; row, col &#125;);</span><br><span class="line">                    </span><br><span class="line">                    int steps = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span> (!q.empty()) &#123;</span><br><span class="line">                        steps++;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">for</span> (int level = q.size(); level &gt; <span class="number">0</span>; --level) &#123;</span><br><span class="line">                            auto curr = q.front();</span><br><span class="line">                            q.pop();</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">for</span> (auto&amp; dir : dirs) &#123;</span><br><span class="line">                                int nextRow = curr.first + dir[<span class="number">0</span>];</span><br><span class="line">                                int nextCol = curr.second + dir[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">                                // For each cell <span class="keyword">with</span> the value equal to empty land value</span><br><span class="line">                                // add distance <span class="keyword">and</span> decrement the cell value by <span class="number">1.</span></span><br><span class="line">                                <span class="keyword">if</span> (nextRow &gt;= <span class="number">0</span> &amp;&amp; nextRow &lt; rows &amp;&amp;</span><br><span class="line">                                    nextCol &gt;= <span class="number">0</span> &amp;&amp; nextCol &lt; cols &amp;&amp;</span><br><span class="line">                                    grid[nextRow][nextCol] == emptyLandValue) &#123;</span><br><span class="line">                                    grid[nextRow][nextCol]--;</span><br><span class="line">                                    total[nextRow][nextCol] += steps;</span><br><span class="line"></span><br><span class="line">                                    q.push(&#123; nextRow, nextCol &#125;);</span><br><span class="line">                                    minDist = min(minDist, total[nextRow][nextCol]);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    // Decrement empty land value to be searched <span class="keyword">in</span> next iteration.</span><br><span class="line">                    emptyLandValue--;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return minDist == INT_MAX ? -1 : minDist;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="alien-dictionary">269. Alien Dictionary</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict, Counter, deque</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">alienOrder</span><span class="params">(self, words: List[str])</span> -&gt; str:</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Step 0: create data structures + the in_degree of each unique letter to 0.</span></span><br><span class="line">        adj_list = defaultdict(set)</span><br><span class="line">        in_degree = Counter(&#123;c : <span class="number">0</span> <span class="keyword">for</span> word <span class="keyword">in</span> words <span class="keyword">for</span> c <span class="keyword">in</span> word&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Step 1: We need to populate adj_list and in_degree.</span></span><br><span class="line">        <span class="comment"># For each pair of adjacent words...</span></span><br><span class="line">        <span class="keyword">for</span> first_word, second_word <span class="keyword">in</span> zip(words, words[<span class="number">1</span>:]):</span><br><span class="line">            <span class="keyword">for</span> c, d <span class="keyword">in</span> zip(first_word, second_word):</span><br><span class="line">                <span class="keyword">if</span> c != d:</span><br><span class="line">                    <span class="keyword">if</span> d <span class="keyword">not</span> <span class="keyword">in</span> adj_list[c]:</span><br><span class="line">                        adj_list[c].add(d)</span><br><span class="line">                        in_degree[d] += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>: <span class="comment"># Check that second word isn't a prefix of first word.</span></span><br><span class="line">                <span class="keyword">if</span> len(second_word) &lt; len(first_word): <span class="keyword">return</span> <span class="string">""</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Step 2: We need to repeatedly pick off nodes with an indegree of 0.</span></span><br><span class="line">        output = []</span><br><span class="line">        queue = deque([c <span class="keyword">for</span> c <span class="keyword">in</span> in_degree <span class="keyword">if</span> in_degree[c] == <span class="number">0</span>])</span><br><span class="line">        <span class="keyword">while</span> queue:</span><br><span class="line">            c = queue.popleft()</span><br><span class="line">            output.append(c)</span><br><span class="line">            <span class="keyword">for</span> d <span class="keyword">in</span> adj_list[c]:</span><br><span class="line">                in_degree[d] -= <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> in_degree[d] == <span class="number">0</span>:</span><br><span class="line">                    queue.append(d)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># If not all letters are in output, that means there was a cycle and so</span></span><br><span class="line">        <span class="comment"># no valid ordering. Return "" as per the problem description.</span></span><br><span class="line">        <span class="keyword">if</span> len(output) &lt; len(in_degree):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">        <span class="comment"># Otherwise, convert the ordering we found into a string and return it.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>.join(output)</span><br></pre></td></tr></table></figure>
<h2 id="binary-tree-maximum-path-sum">124. Binary Tree Maximum Path Sum</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Definition for a binary tree node.</span></span><br><span class="line"><span class="comment"># class TreeNode:</span></span><br><span class="line"><span class="comment">#     def __init__(self, val=0, left=None, right=None):</span></span><br><span class="line"><span class="comment">#         self.val = val</span></span><br><span class="line"><span class="comment">#         self.left = left</span></span><br><span class="line"><span class="comment">#         self.right = right</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">maxPathSum</span><span class="params">(self, root)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type root: TreeNode</span></span><br><span class="line"><span class="string">        :rtype: int</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">max_gain</span><span class="params">(node)</span>:</span></span><br><span class="line">            <span class="keyword">nonlocal</span> max_sum</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> node:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># max sum on the left and right sub-trees of node</span></span><br><span class="line">            left_gain = max(max_gain(node.left), <span class="number">0</span>)</span><br><span class="line">            right_gain = max(max_gain(node.right), <span class="number">0</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># the price to start a new path where `node` is a highest node</span></span><br><span class="line">            price_newpath = node.val + left_gain + right_gain</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># update max_sum if it's better to start a new path</span></span><br><span class="line">            max_sum = max(max_sum, price_newpath)</span><br><span class="line">        </span><br><span class="line">            <span class="comment"># for recursion :</span></span><br><span class="line">            <span class="comment"># return the max gain if continue the same path</span></span><br><span class="line">            <span class="keyword">return</span> node.val + max(left_gain, right_gain)</span><br><span class="line">        max_sum = float(<span class="string">'-inf'</span>)</span><br><span class="line">        max_gain(root)</span><br><span class="line">        <span class="keyword">return</span> max_sum</span><br></pre></td></tr></table></figure>
<h2 id="course-schedule-ii">210. Course Schedule II</h2>
<p>https://leetcode.com/problems/course-schedule-ii/</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict, deque</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findOrder</span><span class="params">(self, numCourses, prerequisites)</span>:</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Prepare the graph</span></span><br><span class="line">        adj_list = defaultdict(list)</span><br><span class="line">        indegree = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> dest, src <span class="keyword">in</span> prerequisites:</span><br><span class="line">            adj_list[src].append(dest)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Record each node's in-degree</span></span><br><span class="line">            indegree[dest] = indegree.get(dest, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Queue for maintainig list of nodes that have 0 in-degree</span></span><br><span class="line">        zero_indegree_queue = deque([k <span class="keyword">for</span> k <span class="keyword">in</span> range(numCourses) <span class="keyword">if</span> k <span class="keyword">not</span> <span class="keyword">in</span> indegree])</span><br><span class="line"></span><br><span class="line">        topological_sorted_order = []</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Until there are nodes in the Q</span></span><br><span class="line">        <span class="keyword">while</span> zero_indegree_queue:</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Pop one node with 0 in-degree</span></span><br><span class="line">            vertex = zero_indegree_queue.popleft()</span><br><span class="line">            topological_sorted_order.append(vertex)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Reduce in-degree for all the neighbors</span></span><br><span class="line">            <span class="keyword">if</span> vertex <span class="keyword">in</span> adj_list:</span><br><span class="line">                <span class="keyword">for</span> neighbor <span class="keyword">in</span> adj_list[vertex]:</span><br><span class="line">                    indegree[neighbor] -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment"># Add neighbor to Q if in-degree becomes 0</span></span><br><span class="line">                    <span class="keyword">if</span> indegree[neighbor] == <span class="number">0</span>:</span><br><span class="line">                        zero_indegree_queue.append(neighbor)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> topological_sorted_order <span class="keyword">if</span> len(topological_sorted_order) == numCourses <span class="keyword">else</span> []</span><br></pre></td></tr></table></figure>
<h2 id="word-break-ii">140. Word Break II</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wordBreak</span><span class="params">(self, s: str, wordDict: List[str])</span> -&gt; List[str]:</span></span><br><span class="line">        <span class="comment"># quick check on the characters,</span></span><br><span class="line">        <span class="comment">#   otherwise it would exceed the time limit for certain test cases.</span></span><br><span class="line">        <span class="keyword">if</span> set(Counter(s).keys()) &gt; set(Counter(<span class="string">""</span>.join(wordDict)).keys()):</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">        wordSet = set(wordDict)</span><br><span class="line"></span><br><span class="line">        dp = [[]] * (len(s)+<span class="number">1</span>)</span><br><span class="line">        dp[<span class="number">0</span>] = [<span class="string">""</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> endIndex <span class="keyword">in</span> range(<span class="number">1</span>, len(s)+<span class="number">1</span>):</span><br><span class="line">            sublist = []</span><br><span class="line">            <span class="comment"># fill up the values in the dp array.</span></span><br><span class="line">            <span class="keyword">for</span> startIndex <span class="keyword">in</span> range(<span class="number">0</span>, endIndex):</span><br><span class="line">                word = s[startIndex:endIndex]</span><br><span class="line">                <span class="keyword">if</span> word <span class="keyword">in</span> wordSet:</span><br><span class="line">                    <span class="keyword">for</span> subsentence <span class="keyword">in</span> dp[startIndex]:</span><br><span class="line">                        sublist.append((subsentence + <span class="string">' '</span> + word).strip())</span><br><span class="line"></span><br><span class="line">            dp[endIndex] = sublist</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dp[len(s)]</span><br></pre></td></tr></table></figure>
<h2 id="subarray-sum-equals-k">560. Subarray Sum Equals K</h2>
<ul>
<li>和two sum 的idea有点像</li>
</ul>
<p>https://leetcode.com/problems/subarray-sum-equals-k/</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">subarraySum</span><span class="params">(self, nums, k)</span>:</span></span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        sums = <span class="number">0</span></span><br><span class="line">        d = dict()</span><br><span class="line">        d[<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(nums)):</span><br><span class="line">            sums += nums[i]</span><br><span class="line">            count += d.get(sums-k,<span class="number">0</span>)</span><br><span class="line">            d[sums] = d.get(sums,<span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span>(count)</span><br></pre></td></tr></table></figure>
<h2 id="serialize-and-deserialize-binary-tree">297. Serialize and Deserialize Binary Tree</h2>
<p>https://leetcode.com/problems/serialize-and-deserialize-binary-tree/</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Definition for a binary tree node.</span></span><br><span class="line"><span class="comment"># class TreeNode(object):</span></span><br><span class="line"><span class="comment">#     def __init__(self, x):</span></span><br><span class="line"><span class="comment">#         self.val = x</span></span><br><span class="line"><span class="comment">#         self.left = None</span></span><br><span class="line"><span class="comment">#         self.right = None</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Codec</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">serialize</span><span class="params">(self, root)</span>:</span></span><br><span class="line">        <span class="string">""" Encodes a tree to a single string.</span></span><br><span class="line"><span class="string">        :type root: TreeNode</span></span><br><span class="line"><span class="string">        :rtype: str</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">rserialize</span><span class="params">(root, string)</span>:</span></span><br><span class="line">            <span class="string">""" a recursive helper function for the serialize() function."""</span></span><br><span class="line">            <span class="comment"># check base case</span></span><br><span class="line">            <span class="keyword">if</span> root <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                string += <span class="string">'None,'</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                string += str(root.val) + <span class="string">','</span></span><br><span class="line">                string = rserialize(root.left, string)</span><br><span class="line">                string = rserialize(root.right, string)</span><br><span class="line">            <span class="keyword">return</span> string</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> rserialize(root, <span class="string">''</span>)</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deserialize</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="string">"""Decodes your encoded data to tree.</span></span><br><span class="line"><span class="string">        :type data: str</span></span><br><span class="line"><span class="string">        :rtype: TreeNode</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">rdeserialize</span><span class="params">(l)</span>:</span></span><br><span class="line">            <span class="string">""" a recursive helper function for deserialization."""</span></span><br><span class="line">            <span class="keyword">if</span> l[<span class="number">0</span>] == <span class="string">'None'</span>:</span><br><span class="line">                l.pop(<span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">                </span><br><span class="line">            root = TreeNode(l[<span class="number">0</span>])</span><br><span class="line">            l.pop(<span class="number">0</span>)</span><br><span class="line">            root.left = rdeserialize(l)</span><br><span class="line">            root.right = rdeserialize(l)</span><br><span class="line">            <span class="keyword">return</span> root</span><br><span class="line"></span><br><span class="line">        data_list = data.split(<span class="string">','</span>)</span><br><span class="line">        root = rdeserialize(data_list)</span><br><span class="line">        <span class="keyword">return</span> root</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="comment"># Your Codec object will be instantiated and called as such:</span></span><br><span class="line"><span class="comment"># ser = Codec()</span></span><br><span class="line"><span class="comment"># deser = Codec()</span></span><br><span class="line"><span class="comment"># ans = deser.deserialize(ser.serialize(root))</span></span><br></pre></td></tr></table></figure>
<h2 id="k-closest-points-to-origin">973. K Closest Points to Origin</h2>
<p>https://leetcode.com/problems/k-closest-points-to-origin/</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">kClosest</span><span class="params">(self, points: List[List[int]], k: int)</span> -&gt; List[List[int]]:</span></span><br><span class="line">        minHeap = []</span><br><span class="line">        <span class="keyword">for</span> x, y <span class="keyword">in</span> points:</span><br><span class="line">            minHeap.append([x*x + y*y, x, y])</span><br><span class="line">            </span><br><span class="line">        heapify(minHeap)</span><br><span class="line">        ans = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(k):</span><br><span class="line">            _, x, y = heappop(minHeap)</span><br><span class="line">            ans.append([x, y])</span><br><span class="line">        <span class="keyword">return</span> ans</span><br></pre></td></tr></table></figure>
<h2 id="cnn">CNN</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Conv2D</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    An implementation of the convolutional layer. We convolve the input with out_channels different filters</span></span><br><span class="line"><span class="string">    and each filter spans all channels in the input.</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, in_channels, out_channels, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">0</span>)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :param in_channels: the number of channels of the input data</span></span><br><span class="line"><span class="string">        :param out_channels: the number of channels of the output(aka the number of filters applied in the layer)</span></span><br><span class="line"><span class="string">        :param kernel_size: the specified size of the kernel(both height and width)</span></span><br><span class="line"><span class="string">        :param stride: the stride of convolution</span></span><br><span class="line"><span class="string">        :param padding: the size of padding. Pad zeros to the input with padding size.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.in_channels = in_channels</span><br><span class="line">        self.out_channels = out_channels</span><br><span class="line">        self.kernel_size = kernel_size</span><br><span class="line">        self.stride = stride</span><br><span class="line">        self.padding = padding</span><br><span class="line"></span><br><span class="line">        self.cache = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        self._init_weights()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_init_weights</span><span class="params">(self)</span>:</span></span><br><span class="line">        np.random.seed(<span class="number">1024</span>)</span><br><span class="line">        self.weight = <span class="number">1e-3</span> * np.random.randn(self.out_channels, self.in_channels, self.kernel_size, self.kernel_size)</span><br><span class="line">        self.bias = np.zeros(self.out_channels)</span><br><span class="line"></span><br><span class="line">        self.dx = <span class="literal">None</span></span><br><span class="line">        self.dw = <span class="literal">None</span></span><br><span class="line">        self.db = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        The forward pass of convolution</span></span><br><span class="line"><span class="string">        :param x: input data of shape (N, C, H, W)</span></span><br><span class="line"><span class="string">        :return: output data of shape (N, self.out_channels, H', W') where H' and W' are determined by the convolution</span></span><br><span class="line"><span class="string">                 parameters. Save necessary variables in self.cache for backward pass</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        out = <span class="literal">None</span></span><br><span class="line">        <span class="comment">#############################################################################</span></span><br><span class="line">        <span class="comment"># <span class="doctag">TODO:</span> Implement the convolution forward pass.                             #</span></span><br><span class="line">        <span class="comment"># Hint: 1) You may use np.pad for padding.                                  #</span></span><br><span class="line">        <span class="comment">#       2) You may implement the convolution with loops                     #</span></span><br><span class="line">        <span class="comment">#############################################################################</span></span><br><span class="line">        stride, f, p, C= self.stride, self.kernel_size, self.padding, self.out_channels</span><br><span class="line">        ConvSize = <span class="keyword">lambda</span> x: (x + p * <span class="number">2</span> - f) // stride + <span class="number">1</span></span><br><span class="line">        N, _, H, W = x.shape</span><br><span class="line">        H_out, W_out = ConvSize(H), ConvSize(W)</span><br><span class="line">        out = np.zeros((N, C, H_out, W_out))</span><br><span class="line">        x_pad = np.pad(x, ((<span class="number">0</span>, <span class="number">0</span>), (<span class="number">0</span>, <span class="number">0</span>), (p, p), (p, p)))</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(N):</span><br><span class="line">            <span class="keyword">for</span> h <span class="keyword">in</span> range(H_out):</span><br><span class="line">                h1, h2 = h * stride, h * stride + f</span><br><span class="line">                <span class="keyword">for</span> w <span class="keyword">in</span> range(W_out):</span><br><span class="line">                    w1, w2 = w * stride, w * stride + f</span><br><span class="line">                    <span class="keyword">for</span> c <span class="keyword">in</span> range(C):</span><br><span class="line">                        out[i, c, h, w] = np.sum(self.weight[c, ...] * x_pad[i, :, h1: h2, w1: w2]) + self.bias[c]</span><br><span class="line"></span><br><span class="line">        <span class="comment">#############################################################################</span></span><br><span class="line">        <span class="comment">#                              END OF YOUR CODE                             #</span></span><br><span class="line">        <span class="comment">#############################################################################</span></span><br><span class="line">        self.cache = x</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">backward</span><span class="params">(self, dout)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        The backward pass of convolution</span></span><br><span class="line"><span class="string">        :param dout: upstream gradients</span></span><br><span class="line"><span class="string">        :return: nothing but dx, dw, and db of self should be updated</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        x = self.cache</span><br><span class="line">        <span class="comment">#############################################################################</span></span><br><span class="line">        <span class="comment"># <span class="doctag">TODO:</span> Implement the convolution backward pass.                            #</span></span><br><span class="line">        <span class="comment"># Hint:                                                                     #</span></span><br><span class="line">        <span class="comment">#       1) You may implement the convolution with loops                     #</span></span><br><span class="line">        <span class="comment">#       2) don't forget padding when computing dx                           #</span></span><br><span class="line">        <span class="comment">#############################################################################</span></span><br><span class="line">        stride, f, p, C = self.stride, self.kernel_size, self.padding, self.out_channels</span><br><span class="line">        N, C_in, H, W = x.shape</span><br><span class="line">        ConvSize = <span class="keyword">lambda</span> x: (x + p * <span class="number">2</span> - f) // stride + <span class="number">1</span></span><br><span class="line">        x_pad = np.pad(x, ((<span class="number">0</span>, <span class="number">0</span>), (<span class="number">0</span>, <span class="number">0</span>), (p, p), (p, p)))</span><br><span class="line">        H_out, W_out = ConvSize(H), ConvSize(W)</span><br><span class="line">        self.dx = np.zeros_like(x_pad)</span><br><span class="line">        self.dw = np.zeros_like(self.weight)</span><br><span class="line">        self.db = np.zeros_like(self.bias)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(N):</span><br><span class="line">            <span class="keyword">for</span> h <span class="keyword">in</span> range(H_out):</span><br><span class="line">                h1, h2 = h * stride, h * stride + f</span><br><span class="line">                <span class="keyword">for</span> w <span class="keyword">in</span> range(W_out):</span><br><span class="line">                    w1, w2 = w * stride, w * stride + f</span><br><span class="line">                    <span class="keyword">for</span> c <span class="keyword">in</span> range(C):</span><br><span class="line">                        <span class="comment"># print(f"i = &#123;i&#125;, c = &#123;c&#125;, h = &#123;h&#125;, w = &#123;w&#125;")</span></span><br><span class="line">                        self.dx[i, :, h1: h2, w1: w2] += self.weight[c, ...] * dout[i, c, h, w]</span><br><span class="line">                        self.dw[c, ...] += x_pad[i, :, h1: h2, w1: w2] * dout[i, c, h, w]</span><br><span class="line">                        self.db[c] += dout[i, c, h, w]</span><br><span class="line">        self.dx = self.dx[:, :, p: -p, p: -p]</span><br><span class="line">        <span class="comment">#############################################################################</span></span><br><span class="line">        <span class="comment">#                              END OF YOUR CODE                             #</span></span><br><span class="line">        <span class="comment">#############################################################################</span></span><br></pre></td></tr></table></figure>
<h2 id="minimum-moves-to-move-a-box-to-their-target-location">1263. Minimum Moves to Move a Box to Their Target Location</h2>
<p>https://leetcode.com/problems/minimum-moves-to-move-a-box-to-their-target-location/</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">minPushBox</span><span class="params">(self, grid: List[List[str]])</span> -&gt; int:</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># this loop is to get the coordinates of target, box and person. Nothing else is gained here</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(grid)):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(len(grid[<span class="number">0</span>])):</span><br><span class="line">                <span class="keyword">if</span> grid[i][j] == <span class="string">"T"</span>:</span><br><span class="line">                    target = (i,j)</span><br><span class="line">                <span class="keyword">if</span> grid[i][j] == <span class="string">"B"</span>:</span><br><span class="line">                    box = (i,j)</span><br><span class="line">                <span class="keyword">if</span> grid[i][j] == <span class="string">"S"</span>:</span><br><span class="line">                    person = (i,j)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># this function checks whether the given coordinates/indices are valid to go</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">valid</span><span class="params">(x,y)</span>:</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>&lt;=x&lt;len(grid) <span class="keyword">and</span> <span class="number">0</span>&lt;=y&lt;len(grid[<span class="number">0</span>]) <span class="keyword">and</span> grid[x][y]!=<span class="string">'#'</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># this function checks whether the person can travel from current position to the destination position.</span></span><br><span class="line">        <span class="comment"># used simple bfs(dfs can also be used here), should be self explainatory if you know BFS.</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">(curr,dest,box)</span>:</span></span><br><span class="line">            que = deque([curr])</span><br><span class="line">            v = set()</span><br><span class="line">            <span class="keyword">while</span> que:</span><br><span class="line">                pos = que.popleft()</span><br><span class="line">                <span class="keyword">if</span> pos == dest: <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">                new_pos = [(pos[<span class="number">0</span>]+<span class="number">1</span>,pos[<span class="number">1</span>]),(pos[<span class="number">0</span>]<span class="number">-1</span>,pos[<span class="number">1</span>]),(pos[<span class="number">0</span>],pos[<span class="number">1</span>]+<span class="number">1</span>),(pos[<span class="number">0</span>],pos[<span class="number">1</span>]<span class="number">-1</span>)]</span><br><span class="line">                <span class="keyword">for</span> x,y <span class="keyword">in</span> new_pos:</span><br><span class="line">                    <span class="keyword">if</span> valid(x,y) <span class="keyword">and</span> (x,y) <span class="keyword">not</span> <span class="keyword">in</span> v <span class="keyword">and</span> (x,y)!=box:</span><br><span class="line">                        v.add((x,y))</span><br><span class="line">                        que.append((x,y))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        q = deque([(<span class="number">0</span>,box,person)])</span><br><span class="line">        vis = &#123;box+person&#125;</span><br><span class="line">        <span class="comment"># this is the main bfs which gives us the answer</span></span><br><span class="line">        <span class="keyword">while</span> q :</span><br><span class="line">            dist, box, person = q.popleft()</span><br><span class="line">            <span class="keyword">if</span> box == target: <span class="comment"># return the distance if box is at the target</span></span><br><span class="line">                <span class="keyword">return</span> dist</span><br><span class="line"></span><br><span class="line">            <span class="comment">#these are the new possible coordinates/indices box can be placed in (up, down, right, left).</span></span><br><span class="line">            b_coord = [(box[<span class="number">0</span>]+<span class="number">1</span>,box[<span class="number">1</span>]),(box[<span class="number">0</span>]<span class="number">-1</span>,box[<span class="number">1</span>]),(box[<span class="number">0</span>],box[<span class="number">1</span>]+<span class="number">1</span>),(box[<span class="number">0</span>],box[<span class="number">1</span>]<span class="number">-1</span>)]</span><br><span class="line">            <span class="comment">#these are the corresponding coordinates the person has to be in to push .. the box into the new coordinates</span></span><br><span class="line">            p_coord = [(box[<span class="number">0</span>]<span class="number">-1</span>,box[<span class="number">1</span>]),(box[<span class="number">0</span>]+<span class="number">1</span>,box[<span class="number">1</span>]),(box[<span class="number">0</span>],box[<span class="number">1</span>]<span class="number">-1</span>),(box[<span class="number">0</span>],box[<span class="number">1</span>]+<span class="number">1</span>)]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> new_box,new_person <span class="keyword">in</span> zip(b_coord,p_coord): </span><br><span class="line">                <span class="comment"># we check if the new box coordinates are valid and our current state is not in vis</span></span><br><span class="line">                <span class="keyword">if</span> valid(*new_box) <span class="keyword">and</span> new_box+box <span class="keyword">not</span> <span class="keyword">in</span> vis:</span><br><span class="line">                    <span class="comment"># we check corresponding person coordinates are valid and if it is possible for the person to reach the new coordinates</span></span><br><span class="line">                    <span class="keyword">if</span> valid(*new_person) <span class="keyword">and</span> check(person,new_person,box):</span><br><span class="line">                        vis.add(new_box+box)</span><br><span class="line">                        q.append((dist+<span class="number">1</span>,new_box,box))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span></span><br></pre></td></tr></table></figure>
<p>Logistic Regression</p>
<p>https://towardsdatascience.com/logistic-regression-detailed-overview-46c4da4303bc</p>
<h2 id="trapping-rain-water">42 Trapping Rain Water</h2>
<p>https://leetcode.com/problems/trapping-rain-water/</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">trap</span><span class="params">(self, height: List[int])</span> -&gt; int:</span></span><br><span class="line">        stack = []</span><br><span class="line">        water = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i, e <span class="keyword">in</span> enumerate(height):</span><br><span class="line">            <span class="comment"># we need to see if we can form a container</span></span><br><span class="line">            <span class="keyword">while</span> stack <span class="keyword">and</span> e &gt;= stack[<span class="number">-1</span>][<span class="number">0</span>]:</span><br><span class="line">                popped, _ = stack.pop()</span><br><span class="line">                <span class="comment"># is it a container though? we have a left border?</span></span><br><span class="line">                <span class="keyword">if</span> stack:</span><br><span class="line">                    left_border, j = stack[<span class="number">-1</span>]</span><br><span class="line">                    <span class="comment"># we compute the water</span></span><br><span class="line">                    water += min(left_border-popped, e-popped)*(i-j<span class="number">-1</span>)</span><br><span class="line">            stack.append((e,i))</span><br><span class="line">        <span class="keyword">return</span> water</span><br></pre></td></tr></table></figure>
<h2 id="huawei">HUAWEI</h2>
<ul>
<li><p>给一个grid world, 0: 可以走, 1: 不可以走, 给定start, end</p></li>
<li><p>找到最短路径 以及多少条路</p></li>
<li><p>思路 BFS 记得存每个level的长度 一个level就是一步，dist就是在这里++</p></li>
<li><p>和topology sort有点像</p></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">m, n = data[<span class="number">0</span>]</span><br><span class="line">start, end = tuple(data[<span class="number">1</span>]), tuple(data[<span class="number">2</span>])</span><br><span class="line">dp = [[<span class="number">0</span>] * n <span class="keyword">for</span> _ <span class="keyword">in</span> range(m)]</span><br><span class="line">dp[start[<span class="number">0</span>]][start[<span class="number">1</span>]] = <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> x, y <span class="keyword">in</span> lakes:</span><br><span class="line">    dp[x][y] = <span class="number">-1</span></span><br><span class="line">q = []</span><br><span class="line">q.append(start)</span><br><span class="line">minDist = <span class="number">0</span></span><br><span class="line">neighbors = [[<span class="number">0</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">-1</span>], [<span class="number">1</span>, <span class="number">0</span>], [<span class="number">-1</span>, <span class="number">0</span>]]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">valid</span><span class="params">(state)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> state[<span class="number">0</span>] &lt; m <span class="keyword">and</span> state[<span class="number">0</span>] &gt;= <span class="number">0</span> <span class="keyword">and</span> state[<span class="number">1</span>] &lt; n <span class="keyword">and</span> state[<span class="number">1</span>] &gt;= <span class="number">0</span></span><br><span class="line"></span><br><span class="line">found = <span class="literal">False</span></span><br><span class="line"><span class="keyword">while</span> q:</span><br><span class="line">    size = len(q)</span><br><span class="line">    <span class="keyword">while</span> size &gt; <span class="number">0</span>:</span><br><span class="line">        cur = q.pop(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> cur == end:</span><br><span class="line">            found = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">for</span> delta <span class="keyword">in</span> neighbors:</span><br><span class="line">            nei = (cur[<span class="number">0</span>] + delta[<span class="number">0</span>], cur[<span class="number">1</span>] + delta[<span class="number">1</span>])</span><br><span class="line">            <span class="keyword">if</span> valid(nei) <span class="keyword">and</span> nei <span class="keyword">not</span> <span class="keyword">in</span> lakes:</span><br><span class="line">                x, y = nei</span><br><span class="line">                <span class="keyword">if</span> dp[x][y] == <span class="number">0</span>:</span><br><span class="line">                    q.append(nei)</span><br><span class="line">                dp[x][y] += dp[cur[<span class="number">0</span>]][cur[<span class="number">1</span>]]</span><br><span class="line">        size -= <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> found:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    minDist += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">print(dp[end[<span class="number">0</span>]][end[<span class="number">1</span>]], minDist)</span><br></pre></td></tr></table></figure>
<h2 id="multibag">MultiBag</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://www.acwing.com/problem/content/4/</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">n2b</span><span class="params">(n)</span>:</span></span><br><span class="line">    b = <span class="number">1</span></span><br><span class="line">    f = []</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> sum(f) + b &lt; n:</span><br><span class="line">            f.append(b)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            f.append(n - sum(f))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        b *= <span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> f</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">n, K = map(int, input().split())</span><br><span class="line"></span><br><span class="line">c, v = [], []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">    cost, value, number = input().split()</span><br><span class="line">    cost, value, number = int(cost), int(value), int(number)</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> n2b(number):</span><br><span class="line">        c.append(k * cost)</span><br><span class="line">        v.append(k * value)</span><br><span class="line"></span><br><span class="line">n = len(c)</span><br><span class="line">f = [[<span class="number">0</span>] * (K + <span class="number">1</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> range(n + <span class="number">1</span>)]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, n):</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">0</span>, K):</span><br><span class="line">        f[i + <span class="number">1</span>][k + <span class="number">1</span>] = f[i][k + <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> k + <span class="number">1</span> &gt;= c[i]:</span><br><span class="line">            f[i + <span class="number">1</span>][k + <span class="number">1</span>] = max(f[i][k + <span class="number">1</span>], f[i][k + <span class="number">1</span> - c[i]] + v[i])</span><br><span class="line">print(f[<span class="number">-1</span>][<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以按01的思路 + 一层k遍历用多少个第i件物品</span></span><br><span class="line"><span class="comment"># f[i][j] = f[i - 1][j]</span></span><br><span class="line"><span class="comment"># for k in range(1, ):</span></span><br><span class="line"><span class="comment">#     if j - k * c[i] &gt;= 0:</span></span><br><span class="line"><span class="comment">#         f[i][j] = max(f[i][j], f[i - 1][j - k * c[i]] + k * v[i])</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://thesong96.github.io/2021/09/25/Deep-Reinforcement-Learning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/baby.png">
      <meta itemprop="name" content="Nansong Yi">
      <meta itemprop="description" content="TheSong is named after IG.TheShy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TheSong">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/25/Deep-Reinforcement-Learning/" class="post-title-link" itemprop="url">Deep Reinforcement Learning</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-25 01:46:39" itemprop="dateCreated datePublished" datetime="2021-09-25T01:46:39-07:00">2021-09-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-10-14 00:17:26" itemprop="dateModified" datetime="2021-10-14T00:17:26-07:00">2021-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Deep-Learning/" itemprop="url" rel="index"><span itemprop="name">Deep Learning</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="经典dqn">经典DQN</h2>
<figure>
<img src="https://i.imgur.com/dsI7w93.png" alt="image-20210925021742794" /><figcaption aria-hidden="true">image-20210925021742794</figcaption>
</figure>
<h2 id="ddqn-with-prioritized-experience-replay">DDQN with Prioritized Experience Replay</h2>
<ul>
<li>k是啥来着? k = batch size?</li>
</ul>
<figure>
<img src="https://i.imgur.com/RLqXKoe.png" alt="image-20210925014701107" /><figcaption aria-hidden="true">image-20210925014701107</figcaption>
</figure>
<p>this blog is reproduced from <a href="https://davidrpugh.github.io/stochastic-expatriate-descent/pytorch/deep-reinforcement-learning/deep-q-networks/2020/04/14/prioritized-experience-replay.html" target="_blank" rel="noopener">here</a>:</p>
<h1 id="improving-the-double-dqn-algorithm-using-prioritized-experience-replay">Improving the Double DQN algorithm using prioritized experience replay</h1>
<blockquote>
<p>Notes on improving the Double DQN algorithm using prioritized experience replay.</p>
</blockquote>
<ul>
<li>branch: 2020-04-14-prioritized-experience-replay</li>
<li>badges: true</li>
<li>image: images/prioritized-experience-replay.png</li>
<li>comments: true</li>
<li>author: David R. Pugh</li>
<li>categories: [pytorch, deep-reinforcement-learning, deep-q-networks]</li>
</ul>
<p>I am continuing to work my way through the <a href="https://www.udacity.com/" target="_blank" rel="noopener">Udacity</a> <a href="https://www.udacity.com/course/deep-reinforcement-learning-nanodegree--nd893" target="_blank" rel="noopener"><em>Deep Reinforcement Learning Nanodegree</em></a>. In this blog post I discuss and implement an important enhancement of the experience replay idea from <a href="https://arxiv.org/abs/1511.05952" target="_blank" rel="noopener"><em>Prioritized Experience Replay</em></a> (Schaul et al 2016).</p>
<p>The following quote from the paper nicely summarizes the key idea.</p>
<blockquote>
<p>Experience replay liberates online learning agents from processing transitions in the exact order they are experienced. Prioritized replay further liberates agents from considering transitions with the same frequency that they are experienced. ... In particular, we propose to more frequently replay transitions with high expected learning progress, as measured by the magnitude of their temporal-difference (TD) error. This prioritization can lead to a loss of diversity, which we alleviate with stochastic prioritization, and introduce bias, which we correct with importance sampling.</p>
</blockquote>
<p>Without further ado let's dive into discussing how to implement prioritized experience replay.</p>
<h2 id="prioritized-experience-replay">Prioritized Experience Replay</h2>
<p>Using an experience replay buffer naturally leads to two issues that need to be addressed.</p>
<ol type="1">
<li>Which experiences should the agent store in the replay buffer?</li>
<li>Which experiences should the agent replay from the buffer in order to learn efficiently?</li>
</ol>
<p>Schaul et al 2016 take the contents of the replay buffer more or less as given and focus solely on answering the second question. That is, the paper focuses on developing a procedure for making the most effective use of the experience replay buffer for learning.</p>
<p>Before discussing the procedure to sample from prioritized experiences, I need to discuss what information a reinforcement learning (RL) agent has available to prioritize its experiences for replay.</p>
<h3 id="prioritization-using-the-temporal-difference-td-error-term">Prioritization using the temporal-difference (TD) error term</h3>
<p>You can't prioritize experiences for learning unless you can measure the importance of each experience in the learning process. The ideal criterion would be the amount that RL agent can learn from experience given the current state (i.e., the expected learning value of the experience).</p>
<p>Unfortunately such an ideal criterion is not directly measurable. However, a reasonable proxy is the magnitude of an experience’s temporal-difference (TD) error <span class="math inline">\(\delta_i\)</span>. The TD-error indicates how "surprising" or "unexpected" the experience is given the current state of the RL agent. Using the TD-error term to prioritize experiences for replay is particularly suitable for incremental, online RL algorithms, such as <a href="https://en.wikipedia.org/wiki/State%E2%80%93action%E2%80%93reward%E2%80%93state%E2%80%93action" target="_blank" rel="noopener">SARSA</a> or <a href="https://en.wikipedia.org/wiki/Q-learning" target="_blank" rel="noopener">Q-learning</a>, as these algorithms already compute the TD-error and update the parameters proportionally.</p>
<p>Using the notation developed in my previous post on <a href="https://davidrpugh.github.io/stochastic-expatriate-descent/pytorch/deep-reinforcement-learning/deep-q-networks/2020/04/11/double-dqn.html" target="_blank" rel="noopener"><em>Improving the DQN algorihtm using Double Q-learning</em></a> the TD-error term can be written as follows.</p>
<p><span class="math display">\[ \delta_{i,t} = R_{i,t+1} + \gamma Q\big(S_{i,t+1}, \underset{a}{\mathrm{argmax}}\ Q(S_{i,t+1}, a; \theta_t); \theta^{-}_t\big) - Q(S_{i,t}, a_{i,t}; \theta_t\big)\]</span></p>
<p>In the cell below I define a function for computing the TD-error (as well as several addition functions that will be used by the RL agent later in the post).</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">synchronize_q_networks</span><span class="params">(q_network_1: nn.Module, q_network_2: nn.Module)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    <span class="string">"""In place, synchronization of q_network_1 and q_network_2."""</span></span><br><span class="line">    _ = q_network_1.load_state_dict(q_network_2.state_dict())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">select_greedy_actions</span><span class="params">(states: torch.Tensor, q_network: nn.Module)</span> -&gt; torch.Tensor:</span></span><br><span class="line">    <span class="string">"""Select the greedy action for the current state given some Q-network."""</span></span><br><span class="line">    _, actions = q_network(states).max(dim=<span class="number">1</span>, keepdim=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">return</span> actions</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">evaluate_selected_actions</span><span class="params">(states: torch.Tensor,</span></span></span><br><span class="line"><span class="function"><span class="params">                              actions: torch.Tensor,</span></span></span><br><span class="line"><span class="function"><span class="params">                              rewards: torch.Tensor,</span></span></span><br><span class="line"><span class="function"><span class="params">                              dones: torch.Tensor,</span></span></span><br><span class="line"><span class="function"><span class="params">                              gamma: float,</span></span></span><br><span class="line"><span class="function"><span class="params">                              q_network: nn.Module)</span> -&gt; torch.Tensor:</span></span><br><span class="line">    <span class="string">"""Compute the Q-values by evaluating the actions given the current states and Q-network."""</span></span><br><span class="line">    next_q_values = q_network(states).gather(dim=<span class="number">1</span>, index=actions)        </span><br><span class="line">    q_values = rewards + (gamma * next_q_values * (<span class="number">1</span> - dones))</span><br><span class="line">    <span class="keyword">return</span> q_values</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">double_q_learning_update</span><span class="params">(states: torch.Tensor,</span></span></span><br><span class="line"><span class="function"><span class="params">                             rewards: torch.Tensor,</span></span></span><br><span class="line"><span class="function"><span class="params">                             dones: torch.Tensor,</span></span></span><br><span class="line"><span class="function"><span class="params">                             gamma: float,</span></span></span><br><span class="line"><span class="function"><span class="params">                             q_network_1: nn.Module,</span></span></span><br><span class="line"><span class="function"><span class="params">                             q_network_2: nn.Module)</span> -&gt; torch.Tensor:</span></span><br><span class="line">    <span class="string">"""Double Q-Learning uses Q-network 1 to select actions and Q-network 2 to evaluate the selected actions."""</span></span><br><span class="line">    actions = select_greedy_actions(states, q_network_1)</span><br><span class="line">    q_values = evaluate_selected_actions(states, actions, rewards, dones, gamma, q_network_2)</span><br><span class="line">    <span class="keyword">return</span> q_values</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">double_q_learning_error</span><span class="params">(states: torch.Tensor,</span></span></span><br><span class="line"><span class="function"><span class="params">                            actions: torch.Tensor,</span></span></span><br><span class="line"><span class="function"><span class="params">                            rewards: torch.Tensor,</span></span></span><br><span class="line"><span class="function"><span class="params">                            next_states: torch.Tensor,</span></span></span><br><span class="line"><span class="function"><span class="params">                            dones: torch.Tensor,</span></span></span><br><span class="line"><span class="function"><span class="params">                            gamma: float,</span></span></span><br><span class="line"><span class="function"><span class="params">                            q_network_1: nn.Module,</span></span></span><br><span class="line"><span class="function"><span class="params">                            q_network_2: nn.Module)</span> -&gt; torch.Tensor:</span></span><br><span class="line">    expected_q_values = double_q_learning_update(next_states, rewards, dones, gamma, q_network_1, q_network_2)</span><br><span class="line">    q_values = q_network_1(states).gather(dim=<span class="number">1</span>, index=actions)</span><br><span class="line">    delta = expected_q_values - q_values</span><br><span class="line">    <span class="keyword">return</span> delta</span><br></pre></td></tr></table></figure>
<p>Now that I have defined a measurable criterion by which an RL agent can prioritize its experiences, I can move on to discussing the major contribution of the Schaul et al 2016 paper which was an efficient procedure for randomly sampling and replaying prioritized experiences.</p>
<h3 id="stochastic-prioritization">Stochastic prioritization</h3>
<p>Schaul et al 2016 introduce a stochastic sampling method that interpolates between pure greedy experience prioritization (i.e., always sampling the highest priority experiences) and uniform random sampling of experience. The probability of sampling experience <span class="math inline">\(i\)</span> is defined as follows.</p>
<p><span class="math display">\[ P(i) = \frac{p_i^{\alpha}}{\sum_{j=0}^{N} p_j^{\alpha}} \]</span></p>
<p>where <span class="math inline">\(p_i &gt; 0\)</span> is the priority of transition <span class="math inline">\(i\)</span>. The exponent <span class="math inline">\(\alpha\)</span> determines how much prioritization is used, with <span class="math inline">\(\alpha = 0\)</span> corresponding to the uniform random sampling case. Note that the probability of being sampled is monotonic in an experience’s priority while guaranteeing a non-zero probability for the lowest-priority experience.</p>
<h3 id="correcting-for-sampling-bias">Correcting for sampling bias</h3>
<p>Estimation of the expected value from stochastic updates relies on those updates being drawn from the same underlying distribution whose expectation you wish to estimate. Prioritized experience replay introduces a form of sampling bias that changes the underlying distribution (whose expectation needs to be estimated) in an uncontrolled fashion. When the underlying distribution changes, the solution to which the algorithm will converge also changes (even if the policy and state distribution are fixed). In order for the algorithm to converge properly, the bias introduced by the prioritized experience replay procedure needs to be corrected.</p>
<p>Schaul et al 2016 correct for this bias using an importance sampling scheme that computes a weight for each sampled experience that can be used when computing the loss for that sample.</p>
<p><span class="math display">\[ w_i = \left(\frac{1}{N}\frac{1}{P(i)}\right)^\beta \]</span></p>
<p>The hyperparameter <span class="math inline">\(\beta \ge 0\)</span> controls how strongly to correct for the bias: <span class="math inline">\(\beta=0\)</span> implies no correction; <span class="math inline">\(\beta=1\)</span> fully compensates for the bias. For stability reasons, since these importance sampling weights are included in the loss, they are be normalized by <span class="math inline">\(\max_i\ w_i\)</span>.</p>
<h3 id="implementation">Implementation</h3>
<p>The <code>PrioritizedExperienceReplayBuffer</code> defined below is a substantial re-write of the <code>ExperienceReplayBuffer</code> that I used in my <a href="https://davidrpugh.github.io/stochastic-expatriate-descent/pytorch/deep-reinforcement-learning/deep-q-networks/2020/04/03/deep-q-networks.html" target="_blank" rel="noopener">previous</a> <a href="https://davidrpugh.github.io/stochastic-expatriate-descent/pytorch/deep-reinforcement-learning/deep-q-networks/2020/04/11/double-dqn.html" target="_blank" rel="noopener">posts</a>.</p>
<p>The most important implementation detail is that instead of using a <a href="https://docs.python.org/3.8/library/collections.html#collections.deque" target="_blank" rel="noopener">fixed-length, double-ended queue</a> as the underlying data structure for storing experiences, I am now using a NumPy <a href="https://docs.scipy.org/doc/numpy/user/basics.rec.html" target="_blank" rel="noopener">structured array</a> to store priority-experience tuples. In addition to cleaning up a lot of the internal implementation details, using a structured array as an internal buffer led to significant performance improvements.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"><span class="keyword">import</span> typing</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_field_names = [</span><br><span class="line">    <span class="string">"state"</span>,</span><br><span class="line">    <span class="string">"action"</span>,</span><br><span class="line">    <span class="string">"reward"</span>,</span><br><span class="line">    <span class="string">"next_state"</span>,</span><br><span class="line">    <span class="string">"done"</span></span><br><span class="line">]</span><br><span class="line">Experience = collections.namedtuple(<span class="string">"Experience"</span>, field_names=_field_names)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrioritizedExperienceReplayBuffer</span>:</span></span><br><span class="line">    <span class="string">"""Fixed-size buffer to store priority, Experience tuples."""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,</span></span></span><br><span class="line"><span class="function"><span class="params">                 batch_size: int,</span></span></span><br><span class="line"><span class="function"><span class="params">                 buffer_size: int,</span></span></span><br><span class="line"><span class="function"><span class="params">                 alpha: float = <span class="number">0.0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 random_state: np.random.RandomState = None)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Initialize an ExperienceReplayBuffer object.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Parameters:</span></span><br><span class="line"><span class="string">        -----------</span></span><br><span class="line"><span class="string">        buffer_size (int): maximum size of buffer</span></span><br><span class="line"><span class="string">        batch_size (int): size of each training batch</span></span><br><span class="line"><span class="string">        alpha (float): Strength of prioritized sampling. Default to 0.0 (i.e., uniform sampling).</span></span><br><span class="line"><span class="string">        random_state (np.random.RandomState): random number generator.</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self._batch_size = batch_size</span><br><span class="line">        self._buffer_size = buffer_size</span><br><span class="line">        self._buffer_length = <span class="number">0</span> <span class="comment"># current number of prioritized experience tuples in buffer</span></span><br><span class="line">        self._buffer = np.empty(self._buffer_size, dtype=[(<span class="string">"priority"</span>, np.float32), (<span class="string">"experience"</span>, Experience)])</span><br><span class="line">        self._alpha = alpha</span><br><span class="line">        self._random_state = np.random.RandomState() <span class="keyword">if</span> random_state <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> random_state</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span> -&gt; int:</span></span><br><span class="line">        <span class="string">"""Current number of prioritized experience tuple stored in buffer."""</span></span><br><span class="line">        <span class="keyword">return</span> self._buffer_length</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">alpha</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Strength of prioritized sampling."""</span></span><br><span class="line">        <span class="keyword">return</span> self._alpha</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">batch_size</span><span class="params">(self)</span> -&gt; int:</span></span><br><span class="line">        <span class="string">"""Number of experience samples per training batch."""</span></span><br><span class="line">        <span class="keyword">return</span> self._batch_size</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">buffer_size</span><span class="params">(self)</span> -&gt; int:</span></span><br><span class="line">        <span class="string">"""Maximum number of prioritized experience tuples stored in buffer."""</span></span><br><span class="line">        <span class="keyword">return</span> self._buffer_size</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(self, experience: Experience)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        <span class="string">"""Add a new experience to memory."""</span></span><br><span class="line">        priority = <span class="number">1.0</span> <span class="keyword">if</span> self.is_empty() <span class="keyword">else</span> self._buffer[<span class="string">"priority"</span>].max()</span><br><span class="line">        <span class="keyword">if</span> self.is_full():</span><br><span class="line">            <span class="keyword">if</span> priority &gt; self._buffer[<span class="string">"priority"</span>].min():</span><br><span class="line">                idx = self._buffer[<span class="string">"priority"</span>].argmin()</span><br><span class="line">                self._buffer[idx] = (priority, experience)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">pass</span> <span class="comment"># low priority experiences should not be included in buffer</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self._buffer[self._buffer_length] = (priority, experience)</span><br><span class="line">            self._buffer_length += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_empty</span><span class="params">(self)</span> -&gt; bool:</span></span><br><span class="line">        <span class="string">"""True if the buffer is empty; False otherwise."""</span></span><br><span class="line">        <span class="keyword">return</span> self._buffer_length == <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_full</span><span class="params">(self)</span> -&gt; bool:</span></span><br><span class="line">        <span class="string">"""True if the buffer is full; False otherwise."""</span></span><br><span class="line">        <span class="keyword">return</span> self._buffer_length == self._buffer_size</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sample</span><span class="params">(self, beta: float)</span> -&gt; typing.Tuple[np.array, np.array, np.array]:</span></span><br><span class="line">        <span class="string">"""Sample a batch of experiences from memory."""</span></span><br><span class="line">        <span class="comment"># use sampling scheme to determine which experiences to use for learning</span></span><br><span class="line">        ps = self._buffer[:self._buffer_length][<span class="string">"priority"</span>]</span><br><span class="line">        sampling_probs = ps**self._alpha / np.sum(ps**self._alpha)</span><br><span class="line">        idxs = self._random_state.choice(np.arange(ps.size),</span><br><span class="line">                                         size=self._batch_size,</span><br><span class="line">                                         replace=<span class="literal">True</span>,</span><br><span class="line">                                         p=sampling_probs)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># select the experiences and compute sampling weights</span></span><br><span class="line">        experiences = self._buffer[<span class="string">"experience"</span>][idxs]        </span><br><span class="line">        weights = (self._buffer_length * sampling_probs[idxs])**-beta</span><br><span class="line">        normalized_weights = weights / weights.max()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> idxs, experiences, normalized_weights</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update_priorities</span><span class="params">(self, idxs: np.array, priorities: np.array)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        <span class="string">"""Update the priorities associated with particular experiences."""</span></span><br><span class="line">        self._buffer[<span class="string">"priority"</span>][idxs] = priorities</span><br></pre></td></tr></table></figure>
<h2 id="refactoring-the-deepqagent-class">Refactoring the <code>DeepQAgent</code> class</h2>
<p>Other than continuing to clean up internal implementation details, nothing really changed from the implementation of the <code>DeepQAgent</code> from my previous posts. I added two additional parameters to the constructor: <code>alpha</code> which controls the strength of the prioritization sampling and <code>beta_annealing_schedule</code> (discussed in detail below) which allows the strength of the sampling bias correction (i.e., the importance sampling weights) to increase as training progresses.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> typing</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn, optim</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">A = typing.TypeVar(<span class="string">'A'</span>, bound=<span class="string">'Agent'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Agent</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">choose_action</span><span class="params">(self, state: np.array)</span> -&gt; int:</span></span><br><span class="line">        <span class="string">"""Rule for choosing an action given the current state of the environment."""</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">learn</span><span class="params">(self, experiences: typing.List[Experience])</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        <span class="string">"""Update the agent's state based on a collection of recent experiences."""</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(self, filepath)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        <span class="string">"""Save any important agent state to a file."""</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">step</span><span class="params">(self,</span></span></span><br><span class="line"><span class="function"><span class="params">             state: np.array,</span></span></span><br><span class="line"><span class="function"><span class="params">             action: int,</span></span></span><br><span class="line"><span class="function"><span class="params">             reward: float,</span></span></span><br><span class="line"><span class="function"><span class="params">             next_state: np.array,</span></span></span><br><span class="line"><span class="function"><span class="params">             done: bool)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        <span class="string">"""Update agent's state after observing the effect of its action on the environment."""</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplmentedError</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DeepQAgent</span><span class="params">(Agent)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,</span></span></span><br><span class="line"><span class="function"><span class="params">                 state_size: int,</span></span></span><br><span class="line"><span class="function"><span class="params">                 action_size: int,</span></span></span><br><span class="line"><span class="function"><span class="params">                 number_hidden_units: int,</span></span></span><br><span class="line"><span class="function"><span class="params">                 optimizer_fn: typing.Callable[[typing.Iterable[nn.Parameter]], optim.Optimizer],</span></span></span><br><span class="line"><span class="function"><span class="params">                 batch_size: int,</span></span></span><br><span class="line"><span class="function"><span class="params">                 buffer_size: int,</span></span></span><br><span class="line"><span class="function"><span class="params">                 alpha: float,</span></span></span><br><span class="line"><span class="function"><span class="params">                 beta_annealing_schedule: typing.Callable[[int], float],</span></span></span><br><span class="line"><span class="function"><span class="params">                 epsilon_decay_schedule: typing.Callable[[int], float],</span></span></span><br><span class="line"><span class="function"><span class="params">                 gamma: float,</span></span></span><br><span class="line"><span class="function"><span class="params">                 update_frequency: int,</span></span></span><br><span class="line"><span class="function"><span class="params">                 seed: int = None)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Initialize a DeepQAgent.</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Parameters:</span></span><br><span class="line"><span class="string">        -----------</span></span><br><span class="line"><span class="string">        state_size (int): the size of the state space.</span></span><br><span class="line"><span class="string">        action_size (int): the size of the action space.</span></span><br><span class="line"><span class="string">        number_hidden_units (int): number of units in the hidden layers.</span></span><br><span class="line"><span class="string">        optimizer_fn (callable): function that takes Q-network parameters and returns an optimizer.</span></span><br><span class="line"><span class="string">        batch_size (int): number of experience tuples in each mini-batch.</span></span><br><span class="line"><span class="string">        buffer_size (int): maximum number of experience tuples stored in the replay buffer.</span></span><br><span class="line"><span class="string">        alpha (float): Strength of prioritized sampling; alpha &gt;= 0.0.</span></span><br><span class="line"><span class="string">        beta_annealing_schedule (callable): function that takes episode number and returns beta &gt;= 0.</span></span><br><span class="line"><span class="string">        epsilon_decay_schdule (callable): function that takes episode number and returns 0 &lt;= epsilon &lt; 1.</span></span><br><span class="line"><span class="string">        alpha (float): rate at which the target q-network parameters are updated.</span></span><br><span class="line"><span class="string">        gamma (float): Controls how much that agent discounts future rewards (0 &lt; gamma &lt;= 1).</span></span><br><span class="line"><span class="string">        update_frequency (int): frequency (measured in time steps) with which q-network parameters are updated.</span></span><br><span class="line"><span class="string">        seed (int): random seed</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self._state_size = state_size</span><br><span class="line">        self._action_size = action_size</span><br><span class="line">        self._device = torch.device(<span class="string">"cuda"</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">"cpu"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># set seeds for reproducibility</span></span><br><span class="line">        self._random_state = np.random.RandomState() <span class="keyword">if</span> seed <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> np.random.RandomState(seed)</span><br><span class="line">        <span class="keyword">if</span> seed <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            torch.manual_seed(seed)</span><br><span class="line">        <span class="keyword">if</span> torch.cuda.is_available():</span><br><span class="line">            torch.backends.cudnn.deterministic = <span class="literal">True</span></span><br><span class="line">            torch.backends.cudnn.benchmark = <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># initialize agent hyperparameters</span></span><br><span class="line">        _replay_buffer_kwargs = &#123;</span><br><span class="line">            <span class="string">"alpha"</span>: alpha,</span><br><span class="line">            <span class="string">"batch_size"</span>: batch_size,</span><br><span class="line">            <span class="string">"buffer_size"</span>: buffer_size,</span><br><span class="line">            <span class="string">"random_state"</span>: self._random_state</span><br><span class="line">        &#125;</span><br><span class="line">        self._memory = PrioritizedExperienceReplayBuffer(**_replay_buffer_kwargs)</span><br><span class="line">        self._beta_annealing_schedule = beta_annealing_schedule</span><br><span class="line">        self._epsilon_decay_schedule = epsilon_decay_schedule</span><br><span class="line">        self._gamma = gamma</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># initialize Q-Networks</span></span><br><span class="line">        self._update_frequency = update_frequency</span><br><span class="line">        self._online_q_network = self._initialize_q_network(number_hidden_units)</span><br><span class="line">        self._target_q_network = self._initialize_q_network(number_hidden_units)</span><br><span class="line">        synchronize_q_networks(self._target_q_network, self._online_q_network)        </span><br><span class="line">        self._online_q_network.to(self._device)</span><br><span class="line">        self._target_q_network.to(self._device)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># initialize the optimizer</span></span><br><span class="line">        self._optimizer = optimizer_fn(self._online_q_network.parameters())</span><br><span class="line"></span><br><span class="line">        <span class="comment"># initialize some counters</span></span><br><span class="line">        self._number_episodes = <span class="number">0</span></span><br><span class="line">        self._number_timesteps = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_initialize_q_network</span><span class="params">(self, number_hidden_units: int)</span> -&gt; nn.Module:</span></span><br><span class="line">        <span class="string">"""Create a neural network for approximating the action-value function."""</span></span><br><span class="line">        q_network = nn.Sequential(</span><br><span class="line">            nn.Linear(in_features=self._state_size, out_features=number_hidden_units),</span><br><span class="line">            nn.ReLU(),</span><br><span class="line">            nn.Linear(in_features=number_hidden_units, out_features=number_hidden_units),</span><br><span class="line">            nn.ReLU(),</span><br><span class="line">            nn.Linear(in_features=number_hidden_units, out_features=self._action_size)</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> q_network</span><br><span class="line">           </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_uniform_random_policy</span><span class="params">(self, state: torch.Tensor)</span> -&gt; int:</span></span><br><span class="line">        <span class="string">"""Choose an action uniformly at random."""</span></span><br><span class="line">        <span class="keyword">return</span> self._random_state.randint(self._action_size)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_greedy_policy</span><span class="params">(self, state: torch.Tensor)</span> -&gt; int:</span></span><br><span class="line">        <span class="string">"""Choose an action that maximizes the action_values given the current state."""</span></span><br><span class="line">        actions = select_greedy_actions(state, self._online_q_network)</span><br><span class="line">        action = (actions.cpu()  <span class="comment"># actions might reside on the GPU!</span></span><br><span class="line">                         .item())</span><br><span class="line">        <span class="keyword">return</span> action</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_epsilon_greedy_policy</span><span class="params">(self, state: torch.Tensor, epsilon: float)</span> -&gt; int:</span></span><br><span class="line">        <span class="string">"""With probability epsilon explore randomly; otherwise exploit knowledge optimally."""</span></span><br><span class="line">        <span class="keyword">if</span> self._random_state.random() &lt; epsilon:</span><br><span class="line">            action = self._uniform_random_policy(state)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            action = self._greedy_policy(state)</span><br><span class="line">        <span class="keyword">return</span> action</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">choose_action</span><span class="params">(self, state: np.array)</span> -&gt; int:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Return the action for given state as per current policy.</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Parameters:</span></span><br><span class="line"><span class="string">        -----------</span></span><br><span class="line"><span class="string">        state (np.array): current state of the environment.</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Return:</span></span><br><span class="line"><span class="string">        --------</span></span><br><span class="line"><span class="string">        action (int): an integer representing the chosen action.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># need to reshape state array and convert to tensor</span></span><br><span class="line">        state_tensor = (torch.from_numpy(state)</span><br><span class="line">                             .unsqueeze(dim=<span class="number">0</span>)</span><br><span class="line">                             .to(self._device))</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># choose uniform at random if agent has insufficient experience</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.has_sufficient_experience():</span><br><span class="line">            action = self._uniform_random_policy(state_tensor)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            epsilon = self._epsilon_decay_schedule(self._number_episodes)</span><br><span class="line">            action = self._epsilon_greedy_policy(state_tensor, epsilon)</span><br><span class="line">        <span class="keyword">return</span> action</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">learn</span><span class="params">(self, idxs: np.array, experiences: np.array, sampling_weights: np.array)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        <span class="string">"""Update the agent's state based on a collection of recent experiences."""</span></span><br><span class="line">        states, actions, rewards, next_states, dones = (torch.Tensor(vs).to(self._device) <span class="keyword">for</span> vs <span class="keyword">in</span> zip(*experiences))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># need to add second dimension to some tensors</span></span><br><span class="line">        actions = (actions.long()</span><br><span class="line">                          .unsqueeze(dim=<span class="number">1</span>))</span><br><span class="line">        rewards = rewards.unsqueeze(dim=<span class="number">1</span>)</span><br><span class="line">        dones = dones.unsqueeze(dim=<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        deltas = double_q_learning_error(states,</span><br><span class="line">                                         actions,</span><br><span class="line">                                         rewards,</span><br><span class="line">                                         next_states,</span><br><span class="line">                                         dones,</span><br><span class="line">                                         self._gamma,</span><br><span class="line">                                         self._online_q_network,</span><br><span class="line">                                         self._target_q_network)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># update experience priorities</span></span><br><span class="line">        priorities = (deltas.abs()</span><br><span class="line">                            .cpu()</span><br><span class="line">                            .detach()</span><br><span class="line">                            .numpy()</span><br><span class="line">                            .flatten())</span><br><span class="line">        self._memory.update_priorities(idxs, priorities + <span class="number">1e-6</span>) <span class="comment"># priorities must be positive!</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># compute the mean squared loss</span></span><br><span class="line">        _sampling_weights = (torch.Tensor(sampling_weights)</span><br><span class="line">                                  .view((<span class="number">-1</span>, <span class="number">1</span>)))</span><br><span class="line">        loss = torch.mean((deltas * _sampling_weights)**<span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># updates the parameters of the online network</span></span><br><span class="line">        self._optimizer.zero_grad()</span><br><span class="line">        loss.backward()</span><br><span class="line">        self._optimizer.step()</span><br><span class="line">        </span><br><span class="line">        synchronize_q_networks(self._target_q_network, self._online_q_network)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_sufficient_experience</span><span class="params">(self)</span> -&gt; bool:</span></span><br><span class="line">        <span class="string">"""True if agent has enough experience to train on a batch of samples; False otherwise."""</span></span><br><span class="line">        <span class="keyword">return</span> len(self._memory) &gt;= self._memory.batch_size</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(self, filepath: str)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Saves the state of the DeepQAgent.</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Parameters:</span></span><br><span class="line"><span class="string">        -----------</span></span><br><span class="line"><span class="string">        filepath (str): filepath where the serialized state should be saved.</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Notes:</span></span><br><span class="line"><span class="string">        ------</span></span><br><span class="line"><span class="string">        The method uses `torch.save` to serialize the state of the q-network, </span></span><br><span class="line"><span class="string">        the optimizer, as well as the dictionary of agent hyperparameters.</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        checkpoint = &#123;</span><br><span class="line">            <span class="string">"q-network-state"</span>: self._online_q_network.state_dict(),</span><br><span class="line">            <span class="string">"optimizer-state"</span>: self._optimizer.state_dict(),</span><br><span class="line">            <span class="string">"agent-hyperparameters"</span>: &#123;</span><br><span class="line">                <span class="string">"alpha"</span>: self._memory.alpha,</span><br><span class="line">                <span class="string">"beta_annealing_schedule"</span>: self._beta_annealing_schedule,</span><br><span class="line">                <span class="string">"batch_size"</span>: self._memory.batch_size,</span><br><span class="line">                <span class="string">"buffer_size"</span>: self._memory.buffer_size,</span><br><span class="line">                <span class="string">"epsilon_decay_schedule"</span>: self._epsilon_decay_schedule,</span><br><span class="line">                <span class="string">"gamma"</span>: self._gamma,</span><br><span class="line">                <span class="string">"update_frequency"</span>: self._update_frequency</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        torch.save(checkpoint, filepath)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">step</span><span class="params">(self,</span></span></span><br><span class="line"><span class="function"><span class="params">             state: np.array,</span></span></span><br><span class="line"><span class="function"><span class="params">             action: int,</span></span></span><br><span class="line"><span class="function"><span class="params">             reward: float,</span></span></span><br><span class="line"><span class="function"><span class="params">             next_state: np.array,</span></span></span><br><span class="line"><span class="function"><span class="params">             done: bool)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Updates the agent's state based on feedback received from the environment.</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Parameters:</span></span><br><span class="line"><span class="string">        -----------</span></span><br><span class="line"><span class="string">        state (np.array): the previous state of the environment.</span></span><br><span class="line"><span class="string">        action (int): the action taken by the agent in the previous state.</span></span><br><span class="line"><span class="string">        reward (float): the reward received from the environment.</span></span><br><span class="line"><span class="string">        next_state (np.array): the resulting state of the environment following the action.</span></span><br><span class="line"><span class="string">        done (bool): True is the training episode is finised; false otherwise.</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        experience = Experience(state, action, reward, next_state, done)</span><br><span class="line">        self._memory.add(experience) </span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> done:</span><br><span class="line">            self._number_episodes += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self._number_timesteps += <span class="number">1</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># every so often the agent should learn from experiences</span></span><br><span class="line">            <span class="keyword">if</span> self._number_timesteps % self._update_frequency == <span class="number">0</span> <span class="keyword">and</span> self.has_sufficient_experience():</span><br><span class="line">                beta = self._beta_annealing_schedule(self._number_episodes)</span><br><span class="line">                idxs, experiences, sampling_weights = self._memory.sample(beta)</span><br><span class="line">                self.learn(idxs, experiences, sampling_weights)</span><br></pre></td></tr></table></figure>
<h2 id="the-training-loop">The Training Loop</h2>
<p>The code for the training loop remains unchanged from previous posts.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"><span class="keyword">import</span> typing</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> gym</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_train_for_at_most</span><span class="params">(agent: Agent, env: gym.Env, max_timesteps: int)</span> -&gt; int:</span></span><br><span class="line">    <span class="string">"""Train agent for a maximum number of timesteps."""</span></span><br><span class="line">    state = env.reset()</span><br><span class="line">    score = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> range(max_timesteps):</span><br><span class="line">        action = agent.choose_action(state)</span><br><span class="line">        next_state, reward, done, _ = env.step(action)</span><br><span class="line">        agent.step(state, action, reward, next_state, done)</span><br><span class="line">        state = next_state</span><br><span class="line">        score += reward</span><br><span class="line">        <span class="keyword">if</span> done:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> score</span><br><span class="line"></span><br><span class="line">                </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_train_until_done</span><span class="params">(agent: Agent, env: gym.Env)</span> -&gt; float:</span></span><br><span class="line">    <span class="string">"""Train the agent until the current episode is complete."""</span></span><br><span class="line">    state = env.reset()</span><br><span class="line">    score = <span class="number">0</span></span><br><span class="line">    done = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> done:</span><br><span class="line">        action = agent.choose_action(state)</span><br><span class="line">        next_state, reward, done, _ = env.step(action)</span><br><span class="line">        agent.step(state, action, reward, next_state, done)</span><br><span class="line">        state = next_state</span><br><span class="line">        score += reward</span><br><span class="line">    <span class="keyword">return</span> score</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">train</span><span class="params">(agent: Agent,</span></span></span><br><span class="line"><span class="function"><span class="params">          env: gym.Env,</span></span></span><br><span class="line"><span class="function"><span class="params">          checkpoint_filepath: str,</span></span></span><br><span class="line"><span class="function"><span class="params">          target_score: float,</span></span></span><br><span class="line"><span class="function"><span class="params">          number_episodes: int,</span></span></span><br><span class="line"><span class="function"><span class="params">          maximum_timesteps=None)</span> -&gt; typing.List[float]:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Reinforcement learning training loop.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Parameters:</span></span><br><span class="line"><span class="string">    -----------</span></span><br><span class="line"><span class="string">    agent (Agent): an agent to train.</span></span><br><span class="line"><span class="string">    env (gym.Env): an environment in which to train the agent.</span></span><br><span class="line"><span class="string">    checkpoint_filepath (str): filepath used to save the state of the trained agent.</span></span><br><span class="line"><span class="string">    number_episodes (int): maximum number of training episodes.</span></span><br><span class="line"><span class="string">    maximum_timesteps (int): maximum number of timesteps per episode.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">    --------</span></span><br><span class="line"><span class="string">    scores (list): collection of episode scores from training.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    scores = []</span><br><span class="line">    most_recent_scores = collections.deque(maxlen=<span class="number">100</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(number_episodes):</span><br><span class="line">        <span class="keyword">if</span> maximum_timesteps <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            score = _train_until_done(agent, env)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            score = _train_for_at_most(agent, env, maximum_timesteps)         </span><br><span class="line">        scores.append(score)</span><br><span class="line">        most_recent_scores.append(score)</span><br><span class="line">        </span><br><span class="line">        average_score = sum(most_recent_scores) / len(most_recent_scores)</span><br><span class="line">        <span class="keyword">if</span> average_score &gt;= target_score:</span><br><span class="line">            print(<span class="string">f"\nEnvironment solved in <span class="subst">&#123;i:d&#125;</span> episodes!\tAverage Score: <span class="subst">&#123;average_score:<span class="number">.2</span>f&#125;</span>"</span>)</span><br><span class="line">            agent.save(checkpoint_filepath)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> (i + <span class="number">1</span>) % <span class="number">100</span> == <span class="number">0</span>:</span><br><span class="line">            print(<span class="string">f"\rEpisode <span class="subst">&#123;i + <span class="number">1</span>&#125;</span>\tAverage Score: <span class="subst">&#123;average_score:<span class="number">.2</span>f&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> scores</span><br></pre></td></tr></table></figure>
<h2 id="solving-the-lunarlander-v2-environment">Solving the <code>LunarLander-v2</code> environment</h2>
<p>In the rest of this blog post I will use the Double DQN algorithm with prioritized experience replay to train an agent to solve the <a href="https://gym.openai.com/envs/LunarLander-v2/" target="_blank" rel="noopener">LunarLander-v2</a> environment from <a href="https://openai.com/" target="_blank" rel="noopener">OpenAI</a>.</p>
<p>In this environment the landing pad is always at coordinates (0,0). The reward for moving the lander from the top of the screen to landing pad and arriving at zero speed is typically between 100 and 140 points. Firing the main engine is -0.3 points each frame (so the lander is incentivized to fire the engine as few times possible). If the lander moves away from landing pad it loses reward (so the lander is incentived to land in the designated landing area). The lander is also incentived to land "gracefully" (and not crash in the landing area!).</p>
<p>A training episode finishes if the lander crashes (-100 points) or comes to rest (+100 points). Each leg with ground contact receives and additional +10 points. The task is considered "solved" if the lander is able to achieve 200 points (I will actually be more stringent and define "solved" as achieving over 200 points on average in the most recent 100 training episodes).</p>
<h3 id="action-space">Action Space</h3>
<p>There are four discrete actions available:</p>
<ol start="0" type="1">
<li>Do nothing.</li>
<li>Fire the left orientation engine.</li>
<li>Fire main engine.</li>
<li>Fire the right orientation engine.</li>
</ol>
<h3 id="colab-specific-environment-setup">Colab specific environment setup</h3>
<p>If you are playing around with this notebook on Google Colab, then you will need to run the following cell in order to install the required OpenAI dependencies into the environment.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!pip install gym[box2d]==<span class="number">0.17</span>.*</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gym</span><br><span class="line"></span><br><span class="line">env = gym.make(<span class="string">'LunarLander-v2'</span>)</span><br><span class="line">_ = env.seed(<span class="number">42</span>)</span><br></pre></td></tr></table></figure>
<pre><code>/Users/pughdr/Research/stochastic-expatriate-descent/env/lib/python3.7/site-packages/gym/logger.py:30: UserWarning: [33mWARN: Box bound precision lowered by casting to float32[0m
  warnings.warn(colorize(&#39;%s: %s&#39;%(&#39;WARN&#39;, msg % args), &#39;yellow&#39;))</code></pre>
<h3 id="creating-a-deepqagent">Creating a <code>DeepQAgent</code></h3>
<p>Before creating an instance of the <code>DeepQAgent</code> with prioritized experience replay I need to define a <span class="math inline">\(\beta\)</span>-annealing schedule, an <span class="math inline">\(\epsilon\)</span>-decay schedule, and choose an optimizer.</p>
<h4 id="beta-annealing-schedule"><span class="math inline">\(\beta\)</span>-annealing schedule</h4>
<p>Due to the inherent non-stationarity of the RL training process, Schaul et al 2016 hypothesize that a small sampling bias can be ignored during early training episodes. Instead of fixing <span class="math inline">\(\beta=1\)</span> (and fully correcting for the bias throughout training) they increase the amount of importance sampling correction as the number of training episodes increase by defining a schedule for <span class="math inline">\(\beta\)</span> that reaches 1 (i.e., full bias correction) only near the end of training.</p>
<p>Note that the choice of <span class="math inline">\(\beta\)</span> interacts with choice of prioritization exponent <span class="math inline">\(\alpha\)</span>: increasing both simultaneously prioritizes sampling more aggressively while at the same time as correcting for it more strongly.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">constant_annealing_schedule</span><span class="params">(n, constant)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> constant</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exponential_annealing_schedule</span><span class="params">(n, rate)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> - np.exp(-rate * n)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fig, ax = plt.subplots(<span class="number">1</span>, <span class="number">1</span>, figsize=(<span class="number">10</span>,<span class="number">6</span>))</span><br><span class="line">ns = np.arange(<span class="number">2000</span>)</span><br><span class="line">rate = <span class="number">1e-2</span></span><br><span class="line">_ = ax.plot(ns, exponential_annealing_schedule(ns, rate))</span><br><span class="line">_ = ax.set_ylabel(<span class="string">r"$\beta$"</span>, rotation=<span class="string">"horizontal"</span>, fontsize=<span class="number">20</span>)</span><br><span class="line">_ = ax.set_xlabel(<span class="string">"Number of Episodes"</span>, fontsize=<span class="number">15</span>)</span><br><span class="line">_ = ax.set_title(<span class="string">r"Typical $\beta$ annealing schedule"</span>, fontsize=<span class="number">15</span>)</span><br></pre></td></tr></table></figure>
<p>​<br />
<img src="https://i.imgur.com/nFq13Mu.png" alt="png" /> ​</p>
<h4 id="epsilon-decay-schedule"><span class="math inline">\(\epsilon\)</span>-decay schedule</h4>
<p>As was the case with the DQN and Double DQN algorithms, the agent chooses its action using an <span class="math inline">\(\epsilon\)</span>-greedy policy. When using an <span class="math inline">\(\epsilon\)</span>-greedy policy, with probability <span class="math inline">\(\epsilon\)</span>, the agent explores the state space by choosing an action uniformly at random from the set of feasible actions; with probability <span class="math inline">\(1-\epsilon\)</span>, the agent exploits its current knowledge by choosing the optimal action given that current state.</p>
<p>As the agent learns and acquires additional knowledge about it environment it makes sense to <em>decrease</em> exploration and <em>increase</em> exploitation by decreasing <span class="math inline">\(\epsilon\)</span>. In practice, it isn't a good idea to decrease <span class="math inline">\(\epsilon\)</span> to zero; instead one typically decreases <span class="math inline">\(\epsilon\)</span> over time according to some schedule until it reaches some minimum value.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">power_decay_schedule</span><span class="params">(episode_number: int,</span></span></span><br><span class="line"><span class="function"><span class="params">                         decay_factor: float,</span></span></span><br><span class="line"><span class="function"><span class="params">                         minimum_epsilon: float)</span> -&gt; float:</span></span><br><span class="line">    <span class="string">"""Power decay schedule found in other practical applications."""</span></span><br><span class="line">    <span class="keyword">return</span> max(decay_factor**episode_number, minimum_epsilon)</span><br><span class="line"></span><br><span class="line">_epsilon_decay_schedule_kwargs = &#123;</span><br><span class="line">    <span class="string">"decay_factor"</span>: <span class="number">0.99</span>,</span><br><span class="line">    <span class="string">"minimum_epsilon"</span>: <span class="number">1e-2</span>,</span><br><span class="line">&#125;</span><br><span class="line">epsilon_decay_schedule = <span class="keyword">lambda</span> n: power_decay_schedule(n, **_epsilon_decay_schedule_kwargs)</span><br></pre></td></tr></table></figure>
<h4 id="choosing-an-optimizer">Choosing an optimizer</h4>
<p>Given the good results I achieved in my previous post using the <a href="https://pytorch.org/docs/stable/optim.html#torch.optim.Adam" target="_blank" rel="noopener">Adam</a> optimizer I decided to continue to use that optimizer here.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> optim</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_optimizer_kwargs = &#123;</span><br><span class="line">    <span class="string">"lr"</span>: <span class="number">1e-3</span>,</span><br><span class="line">    <span class="string">"betas"</span>:(<span class="number">0.9</span>, <span class="number">0.999</span>),</span><br><span class="line">    <span class="string">"eps"</span>: <span class="number">1e-08</span>,</span><br><span class="line">    <span class="string">"weight_decay"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">"amsgrad"</span>: <span class="literal">False</span>,</span><br><span class="line">&#125;</span><br><span class="line">optimizer_fn = <span class="keyword">lambda</span> parameters: optim.Adam(parameters, **_optimizer_kwargs)</span><br></pre></td></tr></table></figure>
<h3 id="training-the-deepqagent">Training the <code>DeepQAgent</code></h3>
<p>Now I am finally ready to train the <code>deep_q_agent</code>. The target score for the <code>LunarLander-v2</code> environment is 200 points on average for at least 100 consecutive episodes. First, I will train an RL agent with <span class="math inline">\(\alpha=0.0\)</span> and <span class="math inline">\(\beta=0\)</span> (throught training) which will recover the uniform random sampling baseline. Then I will re-train the RL agent using prioritized sampling for comparison.</p>
<h4 id="uniform-random-sampling">Uniform random sampling</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">_agent_kwargs = &#123;</span><br><span class="line">    <span class="string">"state_size"</span>: env.observation_space.shape[<span class="number">0</span>],</span><br><span class="line">    <span class="string">"action_size"</span>: env.action_space.n, </span><br><span class="line">    <span class="string">"number_hidden_units"</span>: <span class="number">64</span>,</span><br><span class="line">    <span class="string">"optimizer_fn"</span>: optimizer_fn,</span><br><span class="line">    <span class="string">"epsilon_decay_schedule"</span>: epsilon_decay_schedule,</span><br><span class="line">    <span class="string">"alpha"</span>: <span class="number">0.0</span>,</span><br><span class="line">    <span class="string">"batch_size"</span>: <span class="number">64</span>,</span><br><span class="line">    <span class="string">"buffer_size"</span>: <span class="number">100000</span>,</span><br><span class="line">    <span class="string">"beta_annealing_schedule"</span>: <span class="keyword">lambda</span> n: constant_annealing_schedule(n, <span class="number">0.0</span>),</span><br><span class="line">    <span class="string">"gamma"</span>: <span class="number">0.99</span>,</span><br><span class="line">    <span class="string">"update_frequency"</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="string">"seed"</span>: <span class="literal">None</span>,</span><br><span class="line">&#125;</span><br><span class="line">double_dqn_agent = DeepQAgent(**_agent_kwargs)</span><br><span class="line"></span><br><span class="line">uniform_sampling_scores = train(double_dqn_agent,</span><br><span class="line">                                env,</span><br><span class="line">                                <span class="string">"uniform-sampling-checkpoint.pth"</span>,</span><br><span class="line">                                number_episodes=<span class="number">2000</span>,</span><br><span class="line">                                target_score=float(<span class="string">"inf"</span>))</span><br></pre></td></tr></table></figure>
<pre><code>Episode 100 Average Score: -113.36
Episode 200 Average Score: 51.15
Episode 300 Average Score: 119.37
Episode 400 Average Score: 158.45
Episode 500 Average Score: 154.08
Episode 600 Average Score: 216.22
Episode 700 Average Score: 220.47
Episode 800 Average Score: 229.12
Episode 900 Average Score: 223.13
Episode 1000    Average Score: 230.66
Episode 1100    Average Score: 229.96
Episode 1200    Average Score: 209.60
Episode 1300    Average Score: 190.09
Episode 1400    Average Score: 212.46
Episode 1500    Average Score: 219.84
Episode 1600    Average Score: 226.77
Episode 1700    Average Score: 231.39
Episode 1800    Average Score: 208.05
Episode 1900    Average Score: 183.24
Episode 2000    Average Score: 194.43</code></pre>
<h4 id="prioritized-sampling">Prioritized sampling</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">_agent_kwargs = &#123;</span><br><span class="line">    <span class="string">"state_size"</span>: env.observation_space.shape[<span class="number">0</span>],</span><br><span class="line">    <span class="string">"action_size"</span>: env.action_space.n, </span><br><span class="line">    <span class="string">"number_hidden_units"</span>: <span class="number">64</span>,</span><br><span class="line">    <span class="string">"optimizer_fn"</span>: optimizer_fn,</span><br><span class="line">    <span class="string">"epsilon_decay_schedule"</span>: epsilon_decay_schedule,</span><br><span class="line">    <span class="string">"alpha"</span>: <span class="number">0.5</span>,</span><br><span class="line">    <span class="string">"batch_size"</span>: <span class="number">64</span>,</span><br><span class="line">    <span class="string">"buffer_size"</span>: <span class="number">100000</span>,</span><br><span class="line">    <span class="string">"beta_annealing_schedule"</span>: <span class="keyword">lambda</span> n: exponential_annealing_schedule(n, <span class="number">1e-2</span>),</span><br><span class="line">    <span class="string">"gamma"</span>: <span class="number">0.99</span>,</span><br><span class="line">    <span class="string">"update_frequency"</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="string">"seed"</span>: <span class="literal">None</span>,</span><br><span class="line">&#125;</span><br><span class="line">double_dqn_agent = DeepQAgent(**_agent_kwargs)</span><br><span class="line"></span><br><span class="line">prioritized_sampling_scores = train(double_dqn_agent,</span><br><span class="line">                                    env,</span><br><span class="line">                                    <span class="string">"prioritized-sampling-checkpoint.pth"</span>,</span><br><span class="line">                                    number_episodes=<span class="number">2000</span>,</span><br><span class="line">                                    target_score=float(<span class="string">"inf"</span>))</span><br></pre></td></tr></table></figure>
<pre><code>Episode 100 Average Score: -130.92
Episode 200 Average Score: 15.15
Episode 300 Average Score: 71.90
Episode 400 Average Score: 191.28
Episode 500 Average Score: 226.89
Episode 600 Average Score: 238.60
Episode 700 Average Score: 194.70
Episode 800 Average Score: 227.00
Episode 900 Average Score: 223.78
Episode 1000    Average Score: 228.35
Episode 1100    Average Score: 220.97
Episode 1200    Average Score: 220.92
Episode 1300    Average Score: 241.30
Episode 1400    Average Score: 209.41
Episode 1500    Average Score: 200.94
Episode 1600    Average Score: 202.66
Episode 1700    Average Score: 235.63
Episode 1800    Average Score: 249.41
Episode 1900    Average Score: 237.83
Episode 2000    Average Score: 259.26</code></pre>
<h4 id="plotting-the-time-series-of-scores">Plotting the time series of scores</h4>
<p>I can use <a href="https://pandas.pydata.org/" target="_blank" rel="noopener">Pandas</a> to quickly plot the time series of scores along with a 100 episode moving average. Most obvious difference between the two different sampling strategies is that prioritized sampling reduces, perhaps even eliminates, the significant number of large negative scores. Perhaps this is because prioritized sampling replays exactly those experiences that generate, at least initially, large losses (in magnitude). Over time the RL agent using prioritized sampling learns how to handle those awkward state transitions that led to <em>really</em> poor scores much better than an RL agent that uses uniform random sampling throughout.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uniform_sampling_scores = pd.Series(uniform_sampling_scores, name=<span class="string">"scores"</span>)</span><br><span class="line">prioritized_sampling_scores = pd.Series(prioritized_sampling_scores, name=<span class="string">"scores"</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">fig, axes = plt.subplots(<span class="number">2</span>, <span class="number">1</span>, figsize=(<span class="number">10</span>, <span class="number">6</span>), sharex=<span class="literal">True</span>, sharey=<span class="literal">True</span>)</span><br><span class="line">_ = uniform_sampling_scores.plot(ax=axes[<span class="number">0</span>], label=<span class="string">"Uniform Sampling"</span>)</span><br><span class="line">_ = (uniform_sampling_scores.rolling(window=<span class="number">100</span>)</span><br><span class="line">               .mean()</span><br><span class="line">               .rename(<span class="string">"Rolling Average"</span>)</span><br><span class="line">               .plot(ax=axes[<span class="number">0</span>]))</span><br><span class="line">_ = axes[<span class="number">0</span>].legend()</span><br><span class="line">_ = axes[<span class="number">0</span>].set_ylabel(<span class="string">"Score"</span>)</span><br><span class="line"></span><br><span class="line">_ = prioritized_sampling_scores.plot(ax=axes[<span class="number">1</span>], label=<span class="string">"Double DQN Scores"</span>)</span><br><span class="line">_ = (prioritized_sampling_scores.rolling(window=<span class="number">100</span>)</span><br><span class="line">                      .mean()</span><br><span class="line">                      .rename(<span class="string">"Rolling Average"</span>)</span><br><span class="line">                      .plot(ax=axes[<span class="number">1</span>]))</span><br><span class="line">_ = axes[<span class="number">1</span>].legend()</span><br><span class="line">_ = axes[<span class="number">1</span>].set_ylabel(<span class="string">"Score"</span>)</span><br><span class="line">_ = axes[<span class="number">1</span>].set_xlabel(<span class="string">"Episode Number"</span>)</span><br></pre></td></tr></table></figure>
<p>​<br />
<img src="https://i.imgur.com/W9KbFXx.png" alt="png" /> ​</p>
<h4 id="kernel-density-plot-of-the-scores">Kernel density plot of the scores</h4>
<p>In general, the kernel density plot will be bimodal with one mode less than -100 and a second mode greater than 200. The negative mode corresponds to those training episodes where the agent crash landed and thus scored at most -100; the positive mode corresponds to those training episodes where the agent "solved" the task. The kernel density or scores typically exhibits negative skewness (i.e., a fat left tail): there are lots of ways in which landing the lander can go horribly wrong (resulting in the agent getting a very low score) and only relatively few paths to a gentle landing (and a high score).</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fig, ax = plt.subplots(<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">_ = uniform_sampling_scores.plot(kind=<span class="string">"kde"</span>, ax=ax, label=<span class="string">"Uniform Sampling"</span>)</span><br><span class="line">_ = prioritized_sampling_scores.plot(kind=<span class="string">"kde"</span>, ax=ax, label=<span class="string">"Priority Sampling"</span>)</span><br><span class="line">_ = ax.set_xlabel(<span class="string">"Score"</span>)</span><br><span class="line">_ = ax.set_xscale(<span class="string">"symlog"</span>)</span><br><span class="line">_ = ax.legend()</span><br></pre></td></tr></table></figure>
<p>​<br />
<img src="https://i.imgur.com/ObFtMi7.png" alt="png" /> ​</p>
<h2 id="where-to-go-from-here">Where to go from here?</h2>
<p>Up next in this series will be <a href="https://arxiv.org/abs/1511.06581" target="_blank" rel="noopener"><em>Dueling Network Architectures for Deep Reinforcement Learning</em></a>.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://thesong96.github.io/2021/08/07/HarDNet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/baby.png">
      <meta itemprop="name" content="Nansong Yi">
      <meta itemprop="description" content="TheSong is named after IG.TheShy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TheSong">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/07/HarDNet/" class="post-title-link" itemprop="url">HarDNet</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-08-07 15:16:56" itemprop="dateCreated datePublished" datetime="2021-08-07T15:16:56-07:00">2021-08-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-10-14 01:15:52" itemprop="dateModified" datetime="2021-10-14T01:15:52-07:00">2021-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Object-Detection/" itemprop="url" rel="index"><span itemprop="name">Object Detection</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>https://netron.app/</p>
<p>Hi Nansong,</p>
<p>I reviewed your application for our Robotics Perception Engineer job and am impressed with your background. Our work in DL will involve object detection, pose estimation, distance measurement and planning/control using monocular cameras. We use CenterNet-HarDNet to train the network for our detection job. You can find the original repo here:https://github.com/PingoLH/CenterNet-HarDNet In the above repo, the author has provided a tutorial for training and trained 85-layer network on COCO dataset with 80 classes. Your tasks are:</p>
<ol type="1">
<li>Please read the papers (links in the repo) and briefly discuss with us what’s special about this network and how it is different from YOLO, SSD etc. What’s its advantages and disadvantages in your opinion?</li>
<li>Suppose the platform we need to deploy on is an edge device, so we need to train a 68-layer network with only 3 categories: Person, Animal, Vehicles. For animals we want to include dogs and cats. For vehicles we want to include cars and trucks. Please modify the code in the repo and train a network with above specs. The network doesn’t need to be fully trained. Just show your modified training pipeline works. Note: The author has included a 68-layer architecture in the code.</li>
<li>Bonus: Can you implement mix precision training in the code? You can share your update by Wednesday. We can then have a Zoom interview to take your application to the next stage.</li>
</ol>
<p><a href="https://github.com/PingoLH/CenterNet-HarDNet" target="_blank" rel="noopener"><img src="https://i.imgur.com/4ctG2vA.jpg" alt="img" /></a></p>
<p><a href="https://github.com/PingoLH/CenterNet-HarDNet" target="_blank" rel="noopener">PingoLH/CenterNet-HarDNetgithub.com</a></p>
<h2 id="key-words">Key words</h2>
<ul>
<li>https://yskim0.github.io/paper%20review/2020/09/11/HarDNet/</li>
<li>https://blog.csdn.net/qq_19784349/article/details/114545572</li>
<li>https://blog.csdn.net/honyniu/article/details/86695574?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-4.base&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-4.base</li>
<li>https://blog.csdn.net/jacke121/article/details/104649810?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-10.base&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-10.base</li>
<li>https://www.cnblogs.com/king-lps/p/9559335.html</li>
</ul>
<h1 id="centernet-hardnet">CenterNet-HarDNet</h1>
<h2 id="centernet-objects-as-points">CenterNet: Objects as Points:</h2>
<p><a href="https://arxiv.org/pdf/1904.07850.pdf" target="_blank" rel="noopener">paper link</a></p>
<p>https://medium.com/visionwizard/centernet-objects-as-points-a-comprehensive-guide-2ed9993c48bc</p>
<ul>
<li>Our center point based approach, CenterNet, is end-to-end differentiable, simpler, faster, and more accurate than corresponding bounding box based detectors.</li>
<li>Achieves the best trade-off between speed and accuracy.</li>
<li>First, our CenterNet assigns the “anchor” based solely on location, not box overlap [18]. We have no manual thresholds [18] for foreground and background classification.</li>
<li>Second, we only have one positive “anchor” per object, and hence do not need NonMaximum Suppression (NMS) [2]. We simply extract local peaks in the keypoint heatmap [4, 39].</li>
<li>Third, CenterNet uses a larger output resolution (output stride of 4) compared to traditional object detectors [21, 22] (output stride of 16). This eliminates the need for multiple anchors [47].</li>
</ul>
<h2 id="hardnet">HarDNet</h2>
<p>https://arxiv.org/abs/1909.00948</p>
<h3 id="densenet">DenseNet</h3>
<ul>
<li><p><a href="https://arxiv.org/abs/1608.06993" target="_blank" rel="noopener">paper link</a></p></li>
<li><p>https://towardsdatascience.com/review-densenet-image-classification-b6631a8ef803</p></li>
</ul>
<h4 id="overview">Overview</h4>
<ul>
<li>Comparing with <strong>Standard ConvNet</strong> and <strong>ResNet</strong>, in <strong>DenseNet</strong>, each layer obtains additional inputs from all preceding layers and passes on its own feature-maps to all subsequent layers. <strong>Concatenation</strong> is used. <strong>Each layer is receiving a “collective knowledge” from all preceding layers</strong>.</li>
<li>higher computational efficiency and memory efficiency.</li>
</ul>
<figure>
<img src="https://i.imgur.com/6Dd3YCK.gif" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<h4 id="densenet-architecture">DenseNet Architecture</h4>
<ul>
<li>Basic DenseNet Composition Layer</li>
</ul>
<figure>
<img src="https://i.imgur.com/W9uShbx.gif" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<p>For each composition layer, <strong>Pre-Activation</strong> <a href="https://medium.com/@sh.tsang/review-batch-normalization-inception-v2-bn-inception-the-2nd-to-surpass-human-level-18e2d0f56651" target="_blank" rel="noopener"><strong>Batch Norm (BN)</strong></a> <strong>and ReLU, then 3×3 Conv</strong> are done with output feature maps of <em>k</em> channels, say for example, to transform <em>x</em>0, <em>x</em>1, <em>x</em>2, <em>x</em>3 to <em>x</em>4. This is the idea from <a href="https://towardsdatascience.com/resnet-with-identity-mapping-over-1000-layers-reached-image-classification-bb50a42af03e" target="_blank" rel="noopener"><em>Pre-Activation ResNet</em></a><em>.</em></p>
<h4 id="densenet-b-bottleneck-layers">DenseNet-B (Bottleneck Layers)</h4>
<figure>
<img src="https://i.imgur.com/J9PMp5H.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<figure>
<img src="https://i.imgur.com/PMMlejN.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<p>To reduce the model complexity and size, <strong>BN-ReLU-1×1 Conv</strong> is done before <strong>BN-ReLU-3×3 Conv</strong>.</p>
<h4 id="result">Result</h4>
<ul>
<li><p>compare with <a href="https://towardsdatascience.com/resnet-with-identity-mapping-over-1000-layers-reached-image-classification-bb50a42af03e" target="_blank" rel="noopener"><em>Pre-Activation ResNet</em></a> <img src="https://i.imgur.com/tZK5ul3.png" alt="img" /></p></li>
<li><p>But <strong>why it can be better by keeping the shortcut connection path clean</strong> (by moving the ReLU layer from shortcut connection path to conv layer path as in the figure)?</p></li>
</ul>
<h3 id="downsides-of-previous-detection-algorithms">Downsides of previous detection algorithms</h3>
<ul>
<li>Most successful object detectors enumerate a nearly exhaustive list of potential object locations and classify each. This is wasteful, inefficient, and requires additional post-processing.
<ul>
<li><strong>one stage</strong>: slide a complex arrangement of possible bounding boxes, called anchors, over the image and classify them directly without specifying the box content. Sliding window based object detectors are however a bit wasteful, as they need to enumerate all possible object locations and dimensions.</li>
<li><strong>two stage</strong>: recompute image features for each potential box proposed by xxx?????????? algorithm, then classify those features.</li>
<li><strong>Post-processing</strong>: namely non-maxima suppression, then removes duplicated detections for the same instance by computing bounding box IoU. This post-processing is hard to differentiate and train, hence most current detectors are not end-to-end trainable.</li>
</ul></li>
<li></li>
</ul>
<h2 id="focal-loss">Focal Loss</h2>
<ul>
<li><p>主要是用于解决data imbalance: foreground and background class imbalance.</p></li>
<li><p><a href="https://arxiv.org/pdf/1708.02002.pdf" target="_blank" rel="noopener">paper</a></p></li>
<li><p>https://medium.com/visionwizard/understanding-focal-loss-a-quick-read-b914422913e7</p></li>
</ul>
<h1 id="object-detection-metrics">Object Detection Metrics</h1>
<p><a href="https://github.com/rafaelpadilla/Object-Detection-Metrics" target="_blank" rel="noopener">Academic Paper</a></p>
<h2 id="intersection-over-union">Intersection over Union</h2>
<figure>
<img src="https://i.imgur.com/p9Ma0pN.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<p>IoU metric ranges from 0 and 1 with 0 signifying no overlap and 1 implying perfect overlap between <code>*gt*</code> and <code>*pd*</code>. With IoU metric we need to define a threshold (α, say) that is used to distinguish a valid detection from the one which is not.</p>
<p>We can, therefore, redefine <strong>TP</strong> (correct detection) as a detection for which IoU≥ α and <strong>FP</strong> (invalid detection) with IoU&lt; α. <strong>FN</strong> is a ground-truth missed by the model.</p>
<p>For example, at IoU threshold, α = 0.5 (or 50%), we can define TP, FP and FN as shown in the Fig 4 below.</p>
<figure>
<img src="https://i.imgur.com/XdQOr5z.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<p><strong>Note:</strong> If we raise IoU threshold above 0.86, the first instance will be a FP and if we lower IoU threshold below 0.24, the second instance becomes TP.</p>
<h2 id="precision-and-recall">Precision and Recall</h2>
<p>As started earlier TN are not used in object detection problems and therefore one as to avoid metrics based on this confusion matrix component such as True Negative Rate (TNR), False Positive Rate (FPR), Negative Predictive Value (NPC) and Receiver Operating Characteristic (ROC) curve. Instead, the evaluation of object detection models based on Precision (P) and Recall (R) which are defined as</p>
<figure>
<img src="https://i.imgur.com/wuwFmdC.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<p>Equation 1: Precision and Recall</p>
<p><strong>Precision</strong> is the ability of a classifier to identify relevant objects only. It is the proportion of true positive detections.</p>
<p><strong>Recall</strong>, on the other hand, measures the ability of the model to find all relevant cases (that is, all ground-truths) — the proportion of true positives detected among all ground-truths.</p>
<p>A good model is a model that can identify most ground-truth objects (high recall) while only finding the relevant objects (high precision) often. A perfect model is the one with FN=0 (recall=1) and FP=0 (precision=1). The former is usually the objective, the latter often unattainable.</p>
<h2 id="precision-x-recall-curve-pr-curve">Precision x Recall Curve (PR Curve)</h2>
<p>The precision-recall (PR) curve is a plot of precision as a function of recall. It shows trade-off between the two metrics for varying confidence values for the model detections. If the FP is low, the precision is high but more object instances may be missed yielding high FN — low recall. Conversely, if one accepts more positives by lowering IoU threshold, α, the recall will increase but false positives may also increase, decreasing the precision score. For a good model, both precision and recall should remain high even if the confidence threshold varies.</p>
<h2 id="average-precision">Average Precision</h2>
<p>AP@α is, ideally, the Area Under the PR Curve (AUC-PR). Mathematically, AP is defined as</p>
<figure>
<img src="https://i.imgur.com/ILpUprn.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<p>Equation 2: Definition of Average Precision</p>
<p><strong>Notation:</strong> AP@α or APα means Average Precision(AP) at IoU threshold of α. Therefore AP50 and A75 means AP at IoU threshold of 50% and 75% respectively.</p>
<p>A high AUC-PR implies high precision and high recall. Naturally, often, PR curve is a zigzag-like plot (not monotonically decreasing). We often want to remove this behavior (make the curve to be monotonically decreasing) before calculating the Area Under the Curve (the Average Precision). This is done using interpolation methods. We will discuss two of those interpolation methods below:</p>
<ol type="1">
<li>11-point interpolation method</li>
<li>All-point interpolation approach</li>
</ol>
<h3 id="point-interpolation-method"><strong>11-point interpolation method</strong></h3>
<p>A 11-point AP is a plot of interpolated precision scores for a model results at 11 equally spaced standard recall levels, namely, 0.0, 0.1, 0.2, . . . 1.0. It is defined as</p>
<figure>
<img src="https://i.imgur.com/m4xfneZ.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<p>Equation 3: 11-point interpolation formula</p>
<p>where, R = {0.0, 0.1, 0.2, . . . 1.0} and</p>
<figure>
<img src="https://i.imgur.com/2h6AWHT.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<p>Equation 4 : Supporting equation 3</p>
<p>that is, <strong>interpolated precision at recall value, r —</strong> It is the highest precision for any recall value r’≥ r. If this one doesn’t make sense, I promise you that it will make full sense once we go through an example.</p>
<h3 id="all-point-interpolation-method"><strong>All — point interpolation method</strong></h3>
<p>Unlike 11-point, all-point interpolation interpolates through all the positions, that is</p>
<figure>
<img src="https://i.imgur.com/LGEETks.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<h2 id="mean-average-precision-map">Mean Average Precision (mAP)</h2>
<p><strong>Remark (AP and the number of classes):</strong> AP is calculated individually for each class. This means that there are as many AP values as the number of classes (loosely). These AP values are averaged to obtain the metric: <strong>mean Average Precision (mAP)</strong>. Precisely, mean Average Precision (mAP) is the average of AP values over all classes.</p>
<figure>
<img src="https://i.imgur.com/2WshhJ1.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<figure>
<img src="https://i.imgur.com/BAiGv6u.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<p><strong>Remark (AP and IoU)</strong>: As said earlier, AP is calculated at a given IoU threshold, α. With this reasoning, AP can be calculated over a range of thresholds. <a href="https://arxiv.org/pdf/1405.0312.pdf" target="_blank" rel="noopener">Microsoft COCO</a>, calculated AP of a given category/class at 10 different IoU ranging from 50% to 95% at 5% step-size, usually denoted, AP@[.50:.5:.95]. <a href="https://arxiv.org/pdf/1703.06870.pdf" target="_blank" rel="noopener">Mask R-CNN</a>, reports the average of AP@[.50:.5:.95] simply as AP. It says</p>
<blockquote>
<p>“We report the standard COCO metrics including AP (averaged over IoU thresholds), AP50,AP75, and APS, APM, APL(AP at different scales)” — Extract from Mask R-CNN paper</p>
</blockquote>
<p>To make all these things clearer, let us go through an example.</p>
<h2 id="map计算实例">mAP计算实例</h2>
<p>下面这个blog把object detection里面的AP和mAP讲清楚了</p>
<ul>
<li>https://towardsdatascience.com/on-object-detection-metrics-with-worked-example-216f173ed31e</li>
</ul>
<p>Consider Fig 5 below. It containing 3 images with 12 detections (red bounding boxes) and 9 ground truths(green boxes). Each detection is labelled with a letter and confidence of the prediction. In this example we are considering that all the ground-truths are of the same class (detecting object of the same class) and we will use IoU threshold, α = 50%. The IoU for each detection-truth pair is indicated in Table 1 below. The columns cumTP and cumFP are cumulative values for TP and FP columns respectively. It accumulate TP and FP values above the corresponding confidence level.</p>
<figure>
<img src="https://i.imgur.com/q0FFtdA.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<p>Fig 5 : A model detecting objects of the same class. There are 12 detections and 9 ground-truths.</p>
<figure>
<img src="https://i.imgur.com/gpsIfFp.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<p><strong>Remark (Multiple detections)</strong>: In some cases, there are multiple detections overlapping one ground- truth, e.g. <strong>c,d in image 1</strong>, <strong>g,f in image 2</strong> and <strong>i,k in image 3</strong>. For such cases, a detection with the highest confidence is considered as TP and the rest of the detections as FPs. This is, however, conditioned on the IoU threshold. The detection with the highest confidence should have IoU&gt; threshold otherwise all detections are FPs. After applying this argument</p>
<ul>
<li><strong>c and d becomes FPs</strong> because none of them meets the threshold requirement. <em>c</em> and <em>d</em> have 47% and 42% IoUs respectively against the required 50%.</li>
<li><strong>g is a TP and f is FP</strong>. Both have IoUs greater than 50% but <em>g</em> has a higher confidence of 97% against the confidence of 96% for <em>f</em>.</li>
<li>What about <strong>i</strong> and <strong>k</strong>?</li>
</ul>
<blockquote>
<p>Multiple detections of the same object in an image were considered false detections e.g. 5 detections of a single object counted as 1 correct detection and 4 false detections — <strong>Source: PASCAL VOC 2012 paper</strong>.</p>
<p>Some detectors can output multiple detections overlapping a single ground truth. For those cases the detection with the highest confidence is considered a TP and the others are considered as FP, as applied by the PASCAL VOC 2012 challenge. -Source: <strong>A Survey on Performance Metrics for Object-Detection Algorithms paper.</strong></p>
</blockquote>
<figure>
<img src="https://i.imgur.com/9N1L59Y.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<p>Table 1 : Computation of precision and recall with IoU threshold, α = 50%. IoU is used to determine whether a detection is TP or FP. cumTP and cumFP are cumulative values for TP and FP columns respectively. The all_detections columns is obtained by summing cumTP and cumFP values.</p>
<p><strong>Important:</strong> Before filling up <em>cumTP, cumFP, all_detection, precision and recall</em> you need to sort the table values by confidence, in descending order. precision is cumTP/all_detections and recall is cumTP/number_of_ground_truths. We have 9 ground-truths.</p>
<h3 id="point-interpolation"><strong>11-point interpolation</strong></h3>
<p>To calculate the approximation of AP@0.5 using 11-point interpolation, we need to average the precision values for recall values in R (see Equation 3) , that is, for recall values 0.0, 0.1, 0.2, . . . 1.0. as shown in Fig 6 Right below.</p>
<figure>
<img src="https://i.imgur.com/tBX5IOD.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<figure>
<img src="https://i.imgur.com/qNrloFH.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<figure>
<img src="https://i.imgur.com/OvhT14h.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<p>Fig 6: Left: Plot of all precision-recall values. Right: 11 precision values matching the following recall values: 0.0, 0.1, …, 1.0.</p>
<h3 id="all-point-interpolation">All-point interpolation</h3>
<p>From the definition in Equation 5, we can calculate AP@50 using all-point interpolation as follows</p>
<figure>
<img src="https://i.imgur.com/7Bp52ti.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<figure>
<img src="https://i.imgur.com/NEHLFWJ.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<figure>
<img src="https://i.imgur.com/f2qVmVS.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<p>Fig 7: Left: All point interpolation curve(in red) overlaying the original PR curve. Right: Regions for all-point interpolation</p>
<p>Put simply, all-point interpolation involves calculating and summing area values of the 4 regions (R1, R2, R3 and R4) in Figure 1.3b,that is,</p>
<figure>
<img src="https://i.imgur.com/iK3gljS.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<p>And that is all!</p>
<p><strong>Remark:</strong> Recall that, we said that AP is calculated for each class. Our calculations is for one class. For several classes we can calculate mAP by simply taking the average of the resulting AP values for the different class.</p>
<h2 id="the-coco-challenges-variants">The COCO challenge’s variants</h2>
<p>https://blog.zenggyu.com/en/post/2018-12-16/an-introduction-to-evaluation-metrics-for-object-detection/</p>
<p>The COCO challenge's variants Recall that the Pascal VOC challenge defines the mAP metric using a single loU threshold of <span class="math inline">\(0.5\)</span>. However, the COCO challenge defines several mAP metrics using different thresholds, including:</p>
<ul>
<li><span class="math inline">\(m A P^{I o U=.50: .05: .95}\)</span> which is mAP averaged over 10 loU thresholds (i.e., <span class="math inline">\(0.50,0.55,0.60, \ldots, 0.95)\)</span> and is the primary challenge metric;</li>
<li><span class="math inline">\(m A P^{I o U=.50}\)</span>, which is identical to the Pascal VOC metric;</li>
<li><span class="math inline">\(m A P^{I o U=.75}\)</span>, which is a strict metric.</li>
</ul>
<p>In addition to different loU thresholds, there are also mAP calculated across different object scales; these variants of <span class="math inline">\(\mathrm{mAP}\)</span> are all averaged over 10 loU thresholds (i.e., <span class="math inline">\(0.50,0.55,0.60, \ldots, 0.95\)</span> ):</p>
<ul>
<li><span class="math inline">\(m A P^{\text {small }}\)</span>, which is mAP for small objects that covers area less than <span class="math inline">\(32^{2}\)</span>;</li>
<li><span class="math inline">\(m A P^{\text {medium }}\)</span>, which is <span class="math inline">\(\mathrm{mAP}\)</span> for medium objects that covers area greater than <span class="math inline">\(32^{2}\)</span> but less than <span class="math inline">\(96^{2}\)</span>;</li>
<li><span class="math inline">\(m A P^{\text {large }}\)</span>, which is <span class="math inline">\(\mathrm{mAP}\)</span> for large objects that covers area greater than <span class="math inline">\(96^{2}\)</span></li>
</ul>
<p>Like mAP, the mAR metric also has many variations. One set of mAR variants vary across different numbers of detections per image:</p>
<ul>
<li><span class="math inline">\(m A R^{m a x}=1\)</span>, which is mAR given 1 detection per image;</li>
<li><span class="math inline">\(m A R^{\max =10}\)</span>, which is mAR given 10 detections per image;</li>
<li><span class="math inline">\(m A R^{\max =100}\)</span>, which is mAR given 100 detections per image.</li>
</ul>
<p>The other set of mAR variants vary across the size of detected objects:</p>
<ul>
<li><span class="math inline">\(m A R^{\text {small }}\)</span>, which is mAR for small objects that covers area less than <span class="math inline">\(32^{2}\)</span>;</li>
<li><span class="math inline">\(m A R^{\text {medium }}\)</span>, which is mAR for medium objects that covers area greater than <span class="math inline">\(32^{2}\)</span> but less than <span class="math inline">\(96^{2}\)</span>;</li>
<li><span class="math inline">\(m A R^{\text {large }}\)</span>, which is <span class="math inline">\(\mathrm{mAR}\)</span> for large objects that covers area greater than <span class="math inline">\(96^{2}\)</span>.</li>
</ul>
<h2 id="understanding-coco-dataset">Understanding COCO dataset</h2>
<p>https://majianglin2003.medium.com/object-detection-datasets-coco-ebadb64a21e4</p>
<figure>
<img src="https://i.imgur.com/UP8a1OS.png" alt="image-20210825181629702" /><figcaption aria-hidden="true">image-20210825181629702</figcaption>
</figure>
<figure>
<img src="https://i.imgur.com/WGbHRho.png" alt="image-20210829050828992" /><figcaption aria-hidden="true">image-20210829050828992</figcaption>
</figure>
<p>Big Goals:</p>
<ul>
<li>for daily affordable and sanitary food</li>
<li>pursuit delicious/high quility food</li>
<li>full-stack robots, from preparing food material to cooking, serving and clean all the dishes.</li>
</ul>
<ol type="1">
<li>Problem: now the cooking robots can only make pre-defined food. Tik Tok, connect it with our robots.</li>
<li>recipe repository, like github</li>
<li>How to create a complete document/protocol to define the material, procedure of cooking.</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://thesong96.github.io/2020/11/03/DAYLY-PlAN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/baby.png">
      <meta itemprop="name" content="Nansong Yi">
      <meta itemprop="description" content="TheSong is named after IG.TheShy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TheSong">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/03/DAYLY-PlAN/" class="post-title-link" itemprop="url">DAYLY Summary and Plan</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-11-03 03:19:42" itemprop="dateCreated datePublished" datetime="2020-11-03T03:19:42-08:00">2020-11-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-11-07 14:42:21" itemprop="dateModified" datetime="2020-11-07T14:42:21-08:00">2020-11-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PRL/" itemprop="url" rel="index"><span itemprop="name">PRL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="nov.03.2020">Nov.03.2020</h2>
<h3 id="change-the-structure-of-code-do-retinanet-and-spanet-detection-in-real-tim">Change the structure of code, do RetinaNet and SPANet Detection in Real-Tim</h3>
<h4 id="notation">Notation</h4>
<ol type="1">
<li>[<code>startImg</code>, <code>actImg</code>] -&gt; <code>pix2food</code> -&gt; <code>fakeImg</code>(or pushed image)</li>
<li>startImg<code>: orginal image from camera</code></li>
<li><code>actImg</code>: generated based on food bbox detected from <code>startImg</code>, set some defaults in case no food bbox deteced</li>
<li>fakeImg: <code>generated from</code> pix2food</li>
<li><code>Real Pushed Image</code> = next <code>startImg</code>, it's the ground truth for <code>fakeImg</code></li>
</ol>
<h4 id="high-level-thoughts">high level thoughts:</h4>
<ol type="1">
<li>generate 4 actImg and 4 fakeImg(pushed images) in real-time
<ol type="1">
<li>no matter whether there's food or not (empty plate).</li>
<li>no matter whether the food in the plate is detected or not, when no food, default 4 actImg will be (center of plate -&gt; top, bot, left, right)</li>
</ol></li>
<li>use RetinaNet and SPANet to detect and predict bbox and acquisition for 5 images(1 <code>startImg</code> + 4 <code>fakeImg</code>).
<ol type="1">
<li>what will happen if no food or empty plate in <code>startImg</code>? the <code>fakeImg</code> should be the same as <code>startImg</code>.</li>
<li>However, some artifacts mpotato will show up in fakeImg, due to badly trained <code>pix2food</code>(enhance dataset to cover this case)</li>
</ol></li>
<li>visualize 5 images(1 <code>startImg</code> + 4 <code>fakeImg</code>) with corresponding actImg.</li>
<li>choose the one with best Aquisition Action to pub to <code>Aikido</code>
<ol type="1">
<li>if it's a <code>fakeImg</code> then send the <code>actImg</code> to <code>Ada</code></li>
<li>if it's the <code>startImg</code>, then send <code>scoop</code> to <code>Ada</code></li>
</ol></li>
<li>based on <code>fakeImg</code>, pre plan trajectory for scooping? what if <code>fakeImg</code> doesn't match well with <code>Real Pushed Image</code>?</li>
<li>redo RetinaNet, SPANet on <code>Real Pushed Image</code> then repeat steps above.</li>
</ol>
<h4 id="details">details:</h4>
<ol type="1">
<li>set a callback for camera image topic</li>
<li>in the callback, img -&gt; RetinaNet -&gt; bbox -&gt; SPANet -&gt; 4 MarkerArray</li>
<li>genrate 4 actImg based on bbox(which bbox TBD) with default actImg(from img center to 4 directions)</li>
<li>Pix2Food -&gt; 4 fakeImg -&gt; RetinaNet -&gt; 4 bboxes -&gt; SPANet -&gt; 4 MarkerArray</li>
<li>Publish all 4 fakeImg with actImg associated with them</li>
<li>it's ok when no food show up or no food detected for pix2food for now, deal with it latter</li>
<li>figure out the logic of which marker to pub</li>
</ol>
<h3 id="debugging-ros-network-setup-between-weebo-and-squirrelmy-own-desktop">Debugging ROS Network Setup between <code>weebo</code> and <code>squirrel</code>(my own desktop)</h3>
<ol type="1">
<li>when running only <code>pix2food</code> model on <code>squirrel</code> and everything else on <code>weebo</code>, there will be some bugs as mentioned below</li>
<li>this only happen after I add visualizaiton of [<code>startImg</code>, <code>actImg</code>, <code>fakeImg</code>]</li>
<li>ROS Master cannot revceive msg from <code>reconfig_manager</code>, <code>original</code>, <code>pushed</code> topic and <code>/food/marker_array</code> topic</li>
</ol>
<h3 id="data-collection-improvement">Data Collection Improvement</h3>
<ol type="1">
<li>Empty case: when no mpotato, whatever action given, the image won't change</li>
<li>Reasonable random actImg generator(to generate "whatever action" above).</li>
</ol>
<h2 id="nov.07.2020">Nov.07.2020</h2>
<h3 id="system-design">System Design?</h3>
<h4 id="reconfignetspanetretinanets">ReconfigNet(SPANet(RetinaNets))</h4>
<ul>
<li>check with <code>torch.save</code> make sure it works first!</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://thesong96.github.io/2020/10/30/VSCode-Tricks/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/baby.png">
      <meta itemprop="name" content="Nansong Yi">
      <meta itemprop="description" content="TheSong is named after IG.TheShy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TheSong">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/30/VSCode-Tricks/" class="post-title-link" itemprop="url">VSCode Tricks</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-10-30 00:54:23 / Modified: 01:22:39" itemprop="dateCreated datePublished" datetime="2020-10-30T00:54:23-07:00">2020-10-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Editors/" itemprop="url" rel="index"><span itemprop="name">Editors</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="jump-server">Jump Server</h1>
<h2 id="copy-your-ssh-key-to-jump-server-and-target-server">copy your ssh key to jump-server and target-server</h2>
<ul>
<li>This is your key:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cat ~/.ssh/id_rsa.pub</span><br></pre></td></tr></table></figure>
<ul>
<li>ssh-copy-id</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh-copy-id usrname@server</span><br></pre></td></tr></table></figure>
<ul>
<li>Directly copy to <code>server/~.ssh/authorized_keys</code>, if it doesn’t exist in your server, just create it.</li>
</ul>
<h2 id="setup-your-jump-server">Setup your jump server</h2>
<p>Sometimes you may need to connect from your desktop or laptop to a remote machine over your company's Intranet or behind a firewall. In this case, you may be using an intermediate server or <a href="https://en.wikipedia.org/wiki/Jump_server" target="_blank" rel="noopener">jump box</a>. This kind of setup is useful if you are working within a secure system that is configured to only accept SSH connections from a fixed set of hosts.</p>
<p>To use a jump-box setup with the Remote - SSH extension, you can use the <code>ProxyCommand</code> config option. This configuration will open a background SSH connection to the jump box, and then connect via a private IP address to the target.</p>
<p>You can set the <code>ProxyCommand</code> config option in the SSH config file like this:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Jump box with public IP address</span></span><br><span class="line"><span class="string">Host</span> <span class="string">jump-box</span></span><br><span class="line">    <span class="string">HostName</span> <span class="number">52.179</span><span class="number">.157</span><span class="number">.97</span></span><br><span class="line">    <span class="string">User</span> <span class="string">sana</span></span><br><span class="line">    <span class="string">IdentityFile</span> <span class="string">~/.ssh/jumpbox</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Target machine with private IP address</span></span><br><span class="line"><span class="string">Host</span> <span class="string">target-box</span></span><br><span class="line">    <span class="string">HostName</span> <span class="string">&lt;IP</span> <span class="string">address</span> <span class="string">of</span> <span class="string">target&gt;</span></span><br><span class="line">    <span class="string">User</span> <span class="string">sana</span></span><br><span class="line">    <span class="string">IdentityFile</span> <span class="string">~/.ssh/target</span></span><br><span class="line">    <span class="string">ProxyCommand</span> <span class="string">ssh</span> <span class="string">-q</span> <span class="string">-W</span> <span class="string">%h:%p</span> <span class="string">jump-box</span></span><br></pre></td></tr></table></figure>
<p><em>NOTE</em>: sometimes, the IdentityFile doesn’t work, just comment it out.</p>
<p>In VSCode, press <code>cmd+shift+p</code> and search connect to ssh host.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://thesong96.github.io/2020/03/30/Object-Detection-Algorithms-Review/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/baby.png">
      <meta itemprop="name" content="Nansong Yi">
      <meta itemprop="description" content="TheSong is named after IG.TheShy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TheSong">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/30/Object-Detection-Algorithms-Review/" class="post-title-link" itemprop="url">Object Detection Algorithms Review</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-30 00:41:28" itemprop="dateCreated datePublished" datetime="2020-03-30T00:41:28-07:00">2020-03-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-10-14 01:03:05" itemprop="dateModified" datetime="2021-10-14T01:03:05-07:00">2021-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Deep-Learning/" itemprop="url" rel="index"><span itemprop="name">Deep Learning</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>##Camera 成像原理</p>
<ul>
<li><a href="https://thesong96.github.io/2020/02/27/Camera-Matrix/">Intrisic and Extrinsic Matrix</a></li>
</ul>
<h2 id="object-detections">Object Detections</h2>
<ul>
<li>paper review + blog + algorithm reproduction</li>
<li>SPPNet</li>
<li>Selective Search</li>
<li>R-CNN</li>
<li>Fast-RCNN</li>
<li>Faster-RCNN</li>
<li>Yolo 1,2,3</li>
</ul>
<h2 id="image-segementationsemantic-segmentation">Image Segementation/Semantic Segmentation</h2>
<ul>
<li><p>Vanilla FCN</p></li>
<li><p>U-Net</p></li>
<li><p>SegNet</p></li>
<li><p>DenseNet</p></li>
<li><p>BlitzNet</p></li>
<li><p>Mask-RCNN</p></li>
<li><p>Mask RCNN with the Fully Convolutional Network (FCN) branch achieved the highest performance.</p></li>
</ul>
<h2 id="metrics">Metrics:</h2>
<h3 id="accuracy">Accuracy</h3>
<ul>
<li>accuracy is a bad metric, especially when dataset is imbalenced.
<ul>
<li>class imbalance, e.g. 广告点击率,很多广告<span class="math inline">\((x_i, y_i) i = 0, 1, 2 … n\)</span>, <span class="math inline">\(x_i\)</span>表示第i个广告, <span class="math inline">\(y_i\)</span>表示第i个广告是否被click. 就会出现有大量的<span class="math inline">\(y = 0\)</span>, 这样就是positive data很少很少. 如果用accuracy这个metric去optimize model, 就会得到一个model <span class="math inline">\(F \rightarrow F(x_i) = 0\)</span>, 我们的accuracy会很高, 但是这个model就没什么用, 并不能起到预测广告是否会被点击的作用</li>
<li></li>
</ul></li>
</ul>
<h3 id="precision-recall"><strong>Precision &amp; recall</strong></h3>
<ul>
<li><p>Precision: how good is your prediction</p>
<p>那为啥不用 <span class="math inline">\(\frac{TN}{(TN + FN)}\)</span></p></li>
<li><p>Recall: how good to find out all positive</p></li>
</ul>
<figure>
<img src="https://i.imgur.com/8DMfFLF.jpg" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<h3 id="precision---recall-curve">Precision - Recall Curve</h3>
<p>这个curve和ROC不是一样的吗？？ 又忘记了</p>
<h3 id="roc-curve-tpr---fpr">ROC curve: TPR - FPR</h3>
<h3 id="iou">IOU</h3>
<p>算的时候 记得考虑 两个bbox没有intersection的时候</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">w = max(x_max - x_min, <span class="number">0</span>)</span><br><span class="line">h = max(y_max - y_min, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<h1 id="two-stage-sparse-predition">Two Stage, Sparse Predition</h1>
<h2 id="rcnn">RCNN</h2>
<h2 id="fast-rcnn">Fast-RCNN</h2>
<h2 id="faster-rcnn">Faster-RCNN</h2>
<h2 id="bceloss-derivation">BCEloss derivation:</h2>
<p>Numerically stable version of the binary cross-entropy loss function.</p>
<p>As per https://github.com/pytorch/pytorch/issues/751 See the TensorFlow docs for a derivation of this formula: https://www.tensorflow.org/api_docs/python/tf/nn/sigmoid_cross_entropy_with_logits</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tf.nn.sigmoid_cross_entropy_with_logits(</span><br><span class="line">    labels=<span class="literal">None</span>, logits=<span class="literal">None</span>, name=<span class="literal">None</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>Measures the probability error in discrete classification tasks in which each class is independent and not mutually exclusive. For instance, one could perform multilabel classification where a picture can contain both an elephant and a dog at the same time.</p>
<p>For brevity, let <code>x = logits</code>, <code>z = labels</code>. The logistic loss is</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  z * -log(sigmoid(x)) + (<span class="number">1</span> - z) * -log(<span class="number">1</span> - sigmoid(x))</span><br><span class="line">= z * -log(<span class="number">1</span> / (<span class="number">1</span> + exp(-x))) + (<span class="number">1</span> - z) * -log(exp(-x) / (<span class="number">1</span> + exp(-x)))</span><br><span class="line">= z * log(<span class="number">1</span> + exp(-x)) + (<span class="number">1</span> - z) * (-log(exp(-x)) + log(<span class="number">1</span> + exp(-x)))</span><br><span class="line">= z * log(<span class="number">1</span> + exp(-x)) + (<span class="number">1</span> - z) * (x + log(<span class="number">1</span> + exp(-x))</span><br><span class="line">= (<span class="number">1</span> - z) * x + log(<span class="number">1</span> + exp(-x))</span><br><span class="line">= x - x * z + log(<span class="number">1</span> + exp(-x))</span><br></pre></td></tr></table></figure>
<p>For x &lt; 0, to avoid overflow in exp(-x), we reformulate the above</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  x - x * z + log(<span class="number">1</span> + exp(-x))</span><br><span class="line">= log(exp(x)) - x * z + log(<span class="number">1</span> + exp(-x))</span><br><span class="line">= - x * z + log(<span class="number">1</span> + exp(x))</span><br></pre></td></tr></table></figure>
<p>Hence, to ensure stability and avoid overflow, the implementation uses this equivalent formulation</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">max(x, <span class="number">0</span>) - x * z + log(<span class="number">1</span> + exp(-abs(x)))</span><br></pre></td></tr></table></figure>
<h1 id="one-stage-dense-prediciton">One Stage, Dense Prediciton</h1>
<p>class imbalance problem:</p>
<ol type="1">
<li>Training is inefficient as most locations are easy negatives</li>
<li>The easy negatives can overwhelm training and degenerate the models</li>
</ol>
<h2 id="yolo">Yolo</h2>
<p>v1 <a href="https://arxiv.org/pdf/1506.02640.pdf" target="_blank" rel="noopener">paper</a></p>
<p>DarkNet + Multiscale Feature Map + Regression(bbox + label) + YoloLoss</p>
<h3 id="hence-the-entire-process-of-detection-can-be-summed-up-as"><strong>Hence the entire process of detection can be summed up as:</strong></h3>
<ul>
<li><p>Dividing the image in a grid of S X S</p></li>
<li><p>Detecting bounding box</p></li>
<li><p>Calculating various scores(mentioned in the above image)</p>
<figure>
<img src="https://i.imgur.com/pR6SGJl.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure></li>
<li><p>Depending on the threshold for confidence and IoU, select some boxes</p></li>
<li><p><strong>Use Non-Max suppression</strong>: It helps us to avoid duplicate detections of the same object by rejecting multiple predictions for the same object. It takes a list of predicted boxes for the same image and accepts detection with maximum confidence.</p></li>
<li><p>If the detection is over both IOU and Confidence threshold, It is taken as the final prediction</p></li>
</ul>
<h2 id="loss-and-evaluaton">Loss and Evaluaton</h2>
<p><strong>mAP</strong>:</p>
<p>Mean Average Precision is the metric used for YOLO’s evaluation which can be explored<a href="https://medium.com/@jonathan_hui/map-mean-average-precision-for-object-detection-45c121a31173" target="_blank" rel="noopener">here.</a></p>
<p><strong>Loss function:</strong></p>
<figure>
<img src="https://i.imgur.com/OWSnzJ5.jpg" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<p>It has 4 major parts:</p>
<ul>
<li>Error in X, Y coordinates of the detected object</li>
<li>Error in Height, width of the detected object(root is taken to give less weightage)</li>
<li>Error in Classification. Lambda has been used to give more weightage to Confidence error.</li>
<li>Error in confidence of object detected(similar to log loss)</li>
</ul>
<p><strong>YOLOv3:</strong></p>
<ul>
<li>106 layers neural network</li>
<li>Detection on 3 scales for detecting objects of small to very large size</li>
<li>9 anchor boxes taken; 3 per scale. Hence more bounding boxes are predicted than YOLO9000 &amp; YOLOv1</li>
<li>MultiClass problem turned in MultiLabel problem</li>
<li>Certain changes in the Error function.</li>
<li>Quite good with small objects</li>
</ul>
<h2 id="retinanet">RetinaNet</h2>
<figure>
<img src="https://i.imgur.com/z6Opp98.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<p>ResNet + FPN + classRegression(bbox + label)</p>
<ul>
<li>class subnet: It predicts the probability of an object being present at each spatial location for each anchor box and object class.</li>
<li>box subnet: It's regresses the offset for the bounding boxes from the anchor boxes for each ground-truth object.</li>
</ul>
<h2 id="fpn">FPN</h2>
<p>Goal: Feature integration (combining strong-semantics and weak-semantics) FPN is a general purpose architecture: take a single-scale image as input, generating proportionally sized feature maps at multiple-levels in fully convolutional fashion. FPN is independent to the backbone</p>
<ul>
<li>Region Proposal Network</li>
<li>Object detector</li>
<li>Instance Segmentation</li>
</ul>
<p>FPN is constructed with</p>
<ul>
<li>Bottom-up pathway</li>
<li>Top-down pathway</li>
<li>Lateral connections</li>
</ul>
<h1 id="review">Review</h1>
<h2 id="batchnorm">BatchNorm</h2>
<figure>
<img src="https://pic2.zhimg.com/80/9ad70be49c408d464c71b8e9a006d141_720w.jpg?source=1940ef5c" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<p>Pros: https://zhuanlan.zhihu.com/p/34879333</p>
<ul>
<li><strong>BN使得网络中每层输入数据的分布相对稳定，加速模型学习速度</strong></li>
<li><strong>BN使得模型对网络中的参数不那么敏感，简化调参过程，使得网络学习更加稳定</strong></li>
<li><strong>BN允许网络使用饱和性激活函数（例如sigmoid，tanh等），缓解梯度消失问题</strong></li>
<li><strong>BN具有一定的正则化效果, generalization</strong></li>
</ul>
<h2 id="resnet">Resnet</h2>
<figure>
<img src="https://i.imgur.com/f26P0te.png" alt="image-20210929045534189" /><figcaption aria-hidden="true">image-20210929045534189</figcaption>
</figure>
<p>Why bottlenetck?</p>
<ul>
<li>less parameter</li>
</ul>
<p>Benefits</p>
<ul>
<li>Easy to learn residual funciton F</li>
<li>Go deeper, cuz gradient can flow</li>
<li>Short cut connect doesn’t introduce additional parameters</li>
</ul>
<h2 id="homography">homography</h2>
<h2 id="initializer">Initializer</h2>
<p>why: cuz Vanishing &amp; exploding gradients</p>
<h3 id="he">He</h3>
<h3 id="xavier">Xavier</h3>
<h2 id="optimizer">Optimizer</h2>
<h3 id="sgd">SGD</h3>
<p><span class="math display">\[w =w - dw\]</span></p>
<h3 id="momentum">Momentum</h3>
<p><span class="math inline">\(\begin{aligned} v_{t} &amp;=\beta v_{t-1}-\eta \frac{\partial L}{\partial w} \\ w &amp;=w+v_{t} \end{aligned}\)</span></p>
<ul>
<li>Gradient descent takes a step in the steepest direction (negative gradient)</li>
<li>Intuitive idea: Imagine a ball rolling down loss surface, and use momentum to pass flat surfaces</li>
</ul>
<p>Idea: dynamic learning rate</p>
<h3 id="adagrad">Adagrad</h3>
<p>Idea: Use gradient statistics(curvature) to reduce learning rate across iterations Denominator: Sum up gradients over iterations</p>
<p><span class="math inline">\(G_{i}=G_{i-1}+\left(\frac{\partial L}{\partial w_{i-1}}\right)^{2}\)</span></p>
<p><span class="math inline">\(w_{i}=w_{i-1}-\frac{\alpha}{\sqrt{G_{i}+\epsilon}} \frac{\partial L}{\partial w_{i-1}}\)</span></p>
<p>Directions with high curvature will have higher gradients, and learning rate will reduce</p>
<p>Problem: gradient = 0 after a long time</p>
<h3 id="rmsprop">RMSProp</h3>
<p>Idea: keep a moving avg of <span class="math inline">\(G_i\)</span></p>
<p><span class="math inline">\(G_{i}=\beta G_{i-1}+(1-\beta)\left(\frac{\partial L}{\partial w_{i-1}}\right)^{2}\)</span> <span class="math inline">\(w_{i}=w_{i-1}-\frac{\alpha}{\sqrt{G_{i}+\epsilon}} \frac{\partial L}{\partial w_{i-1}}\)</span></p>
<p>Lr doesn’t saturate to be 0</p>
<h3 id="adam">Adam</h3>
<p>Solution: Time-varying bias correction Typically <span class="math inline">\(\boldsymbol{\beta}_{\mathbf{1}}=\mathbf{0 . 9}, \boldsymbol{\beta}_{\mathbf{2}}=\mathbf{0} . \mathbf{9 9 9}\)</span> So <span class="math inline">\(\widehat{v}_{\boldsymbol{i}}\)</span> will be small number divided by <span class="math inline">\((1-0.9=0.1)\)</span> resulting in more reasonable values (and <span class="math inline">\(\widehat{\boldsymbol{G}}_{i}\)</span> larger)</p>
<p><span class="math inline">\(v_{i}=\boldsymbol{\beta}_{1} v_{i-1}+\left(1-\beta_{1}\right)\left(\frac{\partial L}{\partial w_{i-1}}\right)\)</span> <span class="math inline">\(G_{i}=\beta_{2} G_{i-1}+\left(1-\beta_{2}\right)\left(\frac{\partial L}{\partial w_{i-1}}\right)^{2}\)</span> <span class="math display">\[
\begin{array}{c}\widehat{v}_{i}=\frac{v_{i}}{1-\beta_{1}^{t}} \quad \widehat{G_{i}}=\frac{G_{i}}{1-\beta_{2}^{t}} \\ w_{i}=w_{i-1}-\frac{\alpha \widehat{v}_{i}}{\sqrt{\widehat{G_{i}}+\epsilon}}\end{array}
\]</span></p>
<h2 id="vanishing-gradient">vanishing gradient</h2>
<ul>
<li>activation funciton - Sigmoid,tanh, saturation?</li>
</ul>
<h2 id="overfitting">overfitting</h2>
<ul>
<li>small data set</li>
<li>model complexity too much</li>
<li>Can be solved by regularization</li>
</ul>
<h2 id="data-normalization">data normalization</h2>
<ul>
<li>BatchNorm?</li>
<li><span class="math inline">\(\frac{X - \mu}{\sigma^2}\)</span> normalize it to [0, 1], easy to train when doing gradient descent?</li>
</ul>
<h2 id="epipolar-constraints">epipolar constraints</h2>
<h2 id="camera-calibration">camera calibration</h2>
<p>DLT method: https://www.youtube.com/watch?v=oFZQykvEw14</p>
<p>zhang method: using chessboard.</p>
<p>棋盘上有<span class="math inline">\(\{(i, j)| 0 \leq i\leq n, 0 \leq j\leq m\}\)</span>, n x m个已知坐标点,</p>
<p>就可以构建n x m个这样的方程组 <span class="math inline">\(x_{pix} = K_{3\times3}[R_{w}|t_{w}]_{3\times4}X_{w}\)</span></p>
<p>where</p>
<figure>
<img src="https://i.imgur.com/ut434m3.png" alt="image-20210930093714548" /><figcaption aria-hidden="true">image-20210930093714548</figcaption>
</figure>
<p>考虑到camera skewness</p>
<figure>
<img src="https://i.imgur.com/mNKX4Wy.png" alt="image-20210930084357024" /><figcaption aria-hidden="true">image-20210930084357024</figcaption>
</figure>
<p>Intrinsic <span class="math inline">\(K\)</span>有5个para, Extrinsic <span class="math inline">\([R|t]\)</span> 有6个para, 一共11个para</p>
<p>最少需要6个data pair来求解, 因为每个data pair相当于两个equation</p>
<p>如果考虑distortion, 做法还是一样的 不过需要更多的data pair</p>
<figure>
<img src="https://i.imgur.com/Ioj7xS1.png" alt="image-20210930091906857" /><figcaption aria-hidden="true">image-20210930091906857</figcaption>
</figure>
<p>最后就是一个optimization problem, 优化一下参数</p>
<p>每张照片有很多个点 就可以解出 K, [R|t]</p>
<p>不同角度拍出来的照片[R|t]不一样 但是K一样, K可以一起优化</p>
<h3 id="homogeneous-transformation-review">Homogeneous Transformation review</h3>
<p>https://www.youtube.com/watch?v=kmceHOsxFDI</p>
<h3 id="hand-eye-robot-system">Hand-Eye Robot System</h3>
<p>Core Problem: <span class="math inline">\(AX = XB\)</span></p>
<p>https://www.youtube.com/watch?v=xQ79ysnrzUk&amp;t=2s</p>
<figure>
<img src="https://i.imgur.com/yQrQjC3.png" alt="image-20210929081630505" /><figcaption aria-hidden="true">image-20210929081630505</figcaption>
</figure>
<h2 id="pooling-layer的back-propagation">pooling layer的back-propagation</h2>
<ul>
<li>similar logic with forward</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">backward</span><span class="params">(self, dout)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Backward pass of max pooling</span></span><br><span class="line"><span class="string">    :param dout: Upstream derivatives</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    x, H_out, W_out = self.cache</span><br><span class="line"></span><br><span class="line">    stride, f = self.stride, self.kernel_size</span><br><span class="line">    N, C, H, W = x.shape</span><br><span class="line">    ConvSize = <span class="keyword">lambda</span> x: (x - f) // stride + <span class="number">1</span></span><br><span class="line">    H_out, W_out = ConvSize(H), ConvSize(W)</span><br><span class="line">    self.dx = np.zeros((N, C, H, W))        </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(N):</span><br><span class="line">        <span class="keyword">for</span> h <span class="keyword">in</span> range(H_out):</span><br><span class="line">            h1, h2 = h * stride, h * stride + f</span><br><span class="line">            <span class="keyword">for</span> w <span class="keyword">in</span> range(W_out):</span><br><span class="line">                w1, w2 = w * stride, w * stride + f</span><br><span class="line">                <span class="keyword">for</span> c <span class="keyword">in</span> range(C):</span><br><span class="line">                    self.dx[i, c, h1: h2, w1: w2] += (x[i, c, h1: h2, w1: w2] &gt;= np.max(x[i, c, h1: h2, w1: w2])).astype(float) * dout[i, c, h, w]</span><br></pre></td></tr></table></figure>
<h2 id="d-representation-mesh-point-cloud-voxel">3d representation （mesh, point cloud, voxel）</h2>
<h2 id="stereorectificationdisparity">stereo，rectification，disparity</h2>
<h2 id="rrt">RRT</h2>
<p>https://gitee.com/HaiFengZhiJia/PythonRobotics/blob/master/PathPlanning/RRT/simple_rrt.py</p>
<figure>
<img src="/Users/nansongyi/Library/Application%20Support/typora-user-images/image-20211014003839110.png" alt="image-20211014003839110" /><figcaption aria-hidden="true">image-20211014003839110</figcaption>
</figure>
<hr />
<p>🌲<strong>Recap</strong></p>
<p>Precision = <span class="math inline">\(\frac{tp}{tp + fp}\)</span></p>
<p>Recal = <span class="math inline">\(\frac{tp}{tp + fn}\)</span></p>
<p>Imbalanced Acurray = <span class="math inline">\(\frac{tp + tn}{tp + tn + fp + fn}\)</span> = <span class="math inline">\(\frac{\#classified\quad correctly}{\#all}\)</span> (if the dataset is imbalanced, this metric will be misleading cuz it’s gonna be very high, see <a href="https://en.wikipedia.org/wiki/Precision_and_recall" target="_blank" rel="noopener">example</a>)</p>
<p>Balanced Acurracy = <span class="math inline">\(\frac{TPR + TNR}{2}\)</span></p>
<p>Eg:</p>
<p>Consider a sample with 95 negative and 5 positive values.</p>
<p>Classifying all values as negative in this case.</p>
<p>Imbalanced Acurray = <span class="math inline">\(\frac{tp + tn}{tp + tn + fp + fn}\)</span> = <span class="math inline">\(\frac{0 + 95}{100}\)</span> = 0.95</p>
<p>Balanced Acurray = <span class="math inline">\(\frac{TPR + TNR}{2}\)</span> = <span class="math inline">\(\frac{0/5+95/95}{2}\)</span> = 0.5</p>
<figure>
<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/26/Precisionrecall.svg/350px-Precisionrecall.svg.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<figure>
<img src="https://i.imgur.com/IlBW3bP.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://thesong96.github.io/2020/03/30/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/baby.png">
      <meta itemprop="name" content="Nansong Yi">
      <meta itemprop="description" content="TheSong is named after IG.TheShy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TheSong">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/30/hello-world/" class="post-title-link" itemprop="url">Hello World</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-30 00:39:35" itemprop="dateCreated datePublished" datetime="2020-03-30T00:39:35-07:00">2020-03-30</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="quick-start">Quick Start</h2>
<h3 id="create-a-new-post">Create a new post</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br><span class="line">$ hexo server</span><br><span class="line">$ hexo generate</span><br><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="run-server">Run server</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="generate-static-files">Generate static files</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br><span class="line">$ hexo g -d</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="deploy-to-remote-sites">Deploy to remote sites</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://thesong96.github.io/2020/03/21/MuSHR-Review/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/baby.png">
      <meta itemprop="name" content="Nansong Yi">
      <meta itemprop="description" content="TheSong is named after IG.TheShy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TheSong">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/21/MuSHR-Review/" class="post-title-link" itemprop="url">MuSHR Review</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-21 14:56:23" itemprop="dateCreated datePublished" datetime="2020-03-21T14:56:23-07:00">2020-03-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-09-25 07:03:32" itemprop="dateModified" datetime="2021-09-25T07:03:32-07:00">2021-09-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PRL/" itemprop="url" rel="index"><span itemprop="name">PRL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>This Review is done by <a href="nansongyi96.github.io">Nansong Yi</a> and <a href="https://silencial.github.io/" target="_blank" rel="noopener">Xiangyu Xie</a>.</p>
<h1 id="lab0">Lab0</h1>
<ul>
<li><strong>Localization</strong>: Determine the pose of a robot relative to a given map of the environment.</li>
<li><strong>Mapping</strong>: Construct a map.</li>
<li><strong>Planning</strong>:</li>
</ul>
<h2 id="bayes-filterbayesian-update-rule">Bayes filter(bayesian update rule)</h2>
<p>The <strong>Bayes filter algorithm</strong> includes two steps, the first step is prediction (push belief through dynamics given action), the second step is correction (apply Bayes rule given measurement).</p>
<p><span class="math display">\[
\begin{equation}
\begin{aligned}
\overline{bel}\left(x_{t}\right) &amp;= \int p\left(x_{t} \mid u_{t}, x_{t-1}\right) bel\left(x_{t-1}\right) d x_{t-1} \\
bel\left(x_{t}\right) &amp;= \eta p\left(z_{t} \mid x_{t}\right) \overline{bel}\left(x_{t}\right)
\end{aligned}
\end{equation}
\]</span></p>
<h2 id="kalman-filter">Kalman filter</h2>
<p><strong>Assumptions</strong>:</p>
<ol type="1">
<li>Linear dynamics <span class="math inline">\(p(x_t | u_t, x_{t-1}) = A_{t} x_{t-1}+B_{t} u_{t}+\varepsilon_{t}\)</span>, where <span class="math inline">\(\varepsilon_t \sim \mathcal{N}(0, R_t)\)</span></li>
<li>Linear measurement model <span class="math inline">\(p(z_t | x_t) = C_{t} x_{t}+\delta_{t}\)</span>, where <span class="math inline">\(\delta_t \sim \mathcal{N}(0, Q_t)\)</span></li>
<li>Initial belief <span class="math inline">\(bel(x_0)\)</span> is a gaussian distribution <span class="math display">\[
  bel\left(x_{0}\right)=p\left(x_{0}\right)=\operatorname{det}\left(2 \pi \Sigma_{0}\right)^{-\frac{1}{2}} \exp \left\{-\frac{1}{2}\left(x_{0}-\mu_{0}\right)^{T} \Sigma_{0}^{-1}\left(x_{0}-\mu_{0}\right)\right\}
  \]</span></li>
</ol>
<p><strong>Algorithm</strong>: <span class="math display">\[
\mathbf{\text{Algorithm Kalman_filter(}}\mu_{t-1}, \Sigma_{t-1}, u_t, z_t \mathbf{):} \\
\begin{align*}
\bar{\mu}_{t} &amp;=A_{t} \mu_{t-1}+B_{t} u_{t} \\ 
\bar{\Sigma}_{t} &amp;=A_{t} \Sigma_{t-1} A_{t}^{T}+R_{t} \\ 
K_{t} &amp;=\bar{\Sigma}_{t} C_{t-1}^{T}\left(C_{t} \bar{\Sigma}_{t} C_{t}^{T}+Q_{t}\right)^{-1} \\ 
\mu_{t} &amp;=\bar{\mu}_{t}+K_{t}\left(z_{t}-C_{t} \bar{\mu}_{t}\right) \\
\Sigma_{t} &amp;=\left(I-K_{t} C_{t}\right) \bar{\Sigma}_{t} \\ 
&amp;\text{return } \mu_{t}, \Sigma_{t}
\end{align*}
\]</span></p>
<p>TODO(Nansong): - derive the bayes update rule for Kalman filter and EKF(which represent the present the state (also obeservation?) as probability distribution, i.e gussian distribution, arbitrary distribution) - derive the bayes update rule by hand for particle filter(which represent the state as particles) - analyze the pros and cons, i.e computational and storage expenses, which one is faster. or differences between Kalman Filter and Particle Filter, and specify cases where which algorithms fits better.</p>
<h1 id="lab1">Lab1</h1>
<h2 id="motion-model">Motion model</h2>
<ul>
<li><strong>Kinematic model</strong>: map wheel speeds to robot velocities.</li>
<li><strong>Dynamic model</strong>: map wheel torques to robot accelerations.</li>
</ul>
<p>Consider only kinematic model <span class="math inline">\(p(x_t | u_t, x_{t-1})\)</span> for now (assume we can set the speed directly), then <span class="math inline">\(x = [x, y, \theta]^T\)</span>, <span class="math inline">\(u = [V, \delta]^T\)</span>, where <span class="math inline">\(\theta\)</span> is the heading and <span class="math inline">\(\delta\)</span> is the steering angle.</p>
<p>Now we will derive the motion model for rear axel. Note that a rigid body undergoing rotation and translation can be viewed as pure rotation about a instant center of rotation:</p>
<p>Notes: <mark>How to find CoR? find two points(in our case, front wheels and rear wheels) in a rigid body and find their velocity vectors, the crosspoint of perpendicular lines of two velocity vectors is the CoR.</mark> <img src="https://codimd.s3.shivering-isles.com/demo/uploads/upload_cdea034260cfff09d98139707f3140b0.png" /></p>
<p><mark>TODO: come up with or find other motion model examples apart from race car.</mark></p>
<p><span class="math display">\[
\begin{align*}
&amp;\dot{x}=V \cos (\theta)\\
&amp;\dot{y}=V \sin (\theta)\\
&amp;\dot{\theta}=\omega=\frac{V \tan \delta}{L}
\end{align*}
\]</span></p>
<p>With numerical integration we can get <span class="math display">\[
\begin{align*}
x_{t+1}
&amp;=x_{t}+\frac{L}{\tan (\delta)}\left(\sin \left(\theta_{t+1}\right)-\sin \left(\theta_{t}\right)\right) \\
y_{t+1}
&amp;=y_{t}+\frac{L}{\tan (\delta)}\left(-\cos \left(\theta_{t+1}\right)+\cos \left(\theta_{t}\right)\right) \\
\theta_{t+1}
&amp;=\theta_{t}+\frac{v}{L} \tan (\delta) \Delta t \quad
\end{align*}
\]</span></p>
<h3 id="noise">noise</h3>
<ol type="1">
<li>Control signal error: <span class="math inline">\(\hat{V} \sim \mathcal{N}(V, \sigma_v^2)\)</span>, <span class="math inline">\(\hat{\delta} \sim \mathcal{N}(\delta, \sigma_\delta^2)\)</span></li>
<li>Incorrect physics (the Kinematic Model is inaccurate): <span class="math inline">\(\hat{x} \sim \mathcal{N}\left(x, \sigma_{x}^{2}\right)\)</span>, <span class="math inline">\(\hat{y} \sim \mathcal{N}\left(y, \sigma_{y}^{2}\right)\)</span>, <span class="math inline">\(\hat{\theta} \sim \mathcal{N}\left(\theta, \sigma_{\theta}^{2}\right)\)</span></li>
</ol>
<h2 id="sensor-model">Sensor model</h2>
<p><span class="math inline">\(p(z_t | x_t, m)\)</span> is the probability of sensor reading <span class="math inline">\(z_t\)</span> given state <span class="math inline">\(x_t\)</span> and map <span class="math inline">\(m\)</span>. Calculate simulated sensor reading <span class="math inline">\(z^*\)</span> form <span class="math inline">\(x\)</span> and <span class="math inline">\(m\)</span> and then compare with <span class="math inline">\(z\)</span>.</p>
<p>Assume individual beams are conditionally independent given map <mark>(may result in overconfidence problem)</mark>: <span class="math display">\[
p\left(z_{t} | x_{t}, m\right)=\prod_{i=1}^{K} p\left(z_{t}^{k} | x_{t}, m\right)
\]</span></p>
<h3 id="noise-1">noise</h3>
<ol type="1">
<li><p>Simple measurement noise in distance value <span class="math display">\[
 p_{\text {hit }}\left(z_{t}^{k} | x_{t}, m\right)=\begin{cases}
 \eta \mathcal{N}\left(z_{t}^{k} ; z_{t}^{k *}, \sigma_{\text {hit }}^{2}\right) &amp; \text { if } 0 \leq z_{t}^{k} \leq z_{\max } \\
 0 &amp; \text { otherwise }
 \end{cases}
 \]</span></p></li>
<li><p>Presence of unexpected objects <span class="math display">\[
 p_{\text {short }}\left(z_{t}^{k} | x_{t}, m\right)=\begin{cases}
 \eta \lambda_{\text {short }} e^{-\lambda_{\text {short }} z_{t}^{k}} &amp; \text { if } 0 \leq z_{t}^{k} \leq z_{t}^{k *} \\
 0 &amp; \text { otherwise }
 \end{cases}
 \]</span></p></li>
<li><p>Laser returns max range when no objects <span class="math display">\[
 p_{\max }\left(z_{t}^{k} | x_{t}, m\right)=I\left(z=z_{\max }\right)=\begin{cases}
 1 &amp; \text { if } z=z_{\max } \\
 0 &amp; \text { otherwise }
 \end{cases}
 \]</span></p></li>
<li><p>Failures in sensing <span class="math display">\[
 p_{\text {rand }}\left(z_{t}^{k} | x_{t}, m\right)=\begin{cases}
 \frac{1}{z_{\max }} &amp; \text { if } 0 \leq z_{t}^{k}&lt;z_{\max } \\
 0 &amp; \text { otherwise }
 \end{cases}
 \]</span></p></li>
</ol>
<p>Combine these 4 model to get <span class="math display">\[
p\left(z_{t}^{k} | x_{t}, m\right)=\begin{pmatrix}
z_{\mathrm{hit}} \\
z_{\text {short }} \\
z_{\text {max }} \\
z_{\text {rand }}
\end{pmatrix}^{T} \begin{pmatrix}
p_{\text {hit }}(z_{t}^{k} | x_{t}, m) \\
p_{\text {short }}(z_{t}^{k} | x_{t}, m) \\
p_{\text {max }}(z_{t}^{k} | x_{t}, m) \\
p_{\text {rand }}(z_{t}^{k} | x_{t}, m)
\end{pmatrix}
\]</span></p>
<h2 id="particle-filter">Particle filter</h2>
<p>The particle filter is an alternative <strong>nonparametric</strong> implementation of the Bayes filter. The key idea is to represent the posterior <span class="math inline">\(bel(x_t)\)</span> by a set of random state samples (particles) drawn from this posterior. <span class="math display">\[
\mathbf{\text{Algorithm Particle_filter(}} \mathcal{X}_{t-1}, u_t, z_t \mathbf{):} \\
\begin{align*}
&amp;\bar{\mathcal{X}}_{t}=\mathcal{X}_{t}=\emptyset \\
&amp;\text{for } m=1 \text{ to } M \text{ do} \\
&amp;\qquad \text{sample } x_{t}^{[m]} \sim p\left(x_{t} \mid u_{t}, x_{t-1}^{[m]}\right) \\ 
&amp;\qquad {w_{t}^{[m]}=p\left(z_{t} \mid x_{t}^{[m]}\right)} \\
&amp;\qquad {\bar{\mathcal{X}}_{t}=\bar{\mathcal{X}}_{t}+\left\langle x_{t}^{[m]}, w_{t}^{[m]}\right\rangle} \\
&amp;\text{endfor } \\
&amp;\text{for } m = 1 \text{ to } M \text{ do} \\
&amp;\qquad \text{draw } i \text{ with probability } \propto w_{t}^{[i]} \\
&amp;\qquad \text{add } x_t^{[i]} \text{ to } \mathcal{X}_t \\
&amp;\text{endfor} \\
&amp;\text{return } \mathcal{X}_t
\end{align*}
\]</span></p>
<p>We first sample <span class="math inline">\(x_t\)</span> from the state transition distribution, then calculate the <strong>importance factor</strong>, <span class="math inline">\(w_t\)</span>. In the next loop, we do the <strong>resampling</strong>/<strong>importance sampling</strong>, to change the distribution of particles from <span class="math inline">\(\overline{bel}(x_t)\)</span> to <span class="math inline">\(bel(x_t)\)</span>.</p>
<h3 id="resample">resample</h3>
<p>Resampling can cause high-variance (low-entropy) problem, where particles are depleted. Possible fixes:</p>
<ol type="1">
<li>If the variance of weights low, don't resample.</li>
<li>Use low-variance sampling.</li>
</ol>
<p>TODO(Nansong) - explain normal importance sampling? - differece between importance sampling and low-varience sampling? or is low-varience sampling is one method of importance sampling ?</p>
<p><span class="math display">\[
\mathbf{\text{Algorithm Low_variance_sampler(}} \mathcal{X}_{t}, \mathcal{W}_{t} \mathbf{):} \\
\begin{align*}
&amp;\bar{X}_{t}=\emptyset \\
&amp;r=\operatorname{rand}\left(0 ; M^{-1}\right) \\
&amp;c=w_{t}^{[1]} \\
&amp;i=1 \\
&amp;\text{for } m=1 \text{ to } M \text{ do} \\
&amp;\qquad U=r+(m-1) \cdot M^{-1} \\ 
&amp;\qquad \text{while } U &gt; c \\
&amp;\qquad\quad i=i+1 \\
&amp;\qquad\quad c=c+w_{t}^{[i]} \\
&amp;\qquad \text{endwhile} \\
&amp;\qquad \text{add } x_{t}^{[i]} \text{ to } \bar{X}_{t} \\
&amp;\text{endfor } \\
&amp;\text{return } \bar{\mathcal{X}}_t
\end{align*}
\]</span></p>
<p><img src="https://codimd.s3.shivering-isles.com/demo/uploads/upload_4843cc831aa0cfd6384fbe8c8d4a1135.png" /></p>
<p>TODO(Nansong): - give a python implementation of this low varience resample algorithm - give a python implementation of importance sampling of arbitrary probability distribution</p>
<h3 id="expected-pose">expected pose</h3>
<p>Calculate expected pose from particles: <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> can be computed directly by the weighted average. However, the weighted average of <span class="math inline">\(\theta\)</span> is not accurate. Thus we use cosine and sine averaging. (<a href="https://en.wikipedia.org/wiki/Mean_of_circular_quantities" target="_blank" rel="noopener">Ref</a>)</p>
<h2 id="code">Code</h2>
<p><code>MotionModel.py</code>:</p>
<ol type="1">
<li>Subscribe to motor topic, get control info (speed and steering angle), also save last frame info for calculation.</li>
<li>Add variance to speed and steering angle. Apply motion model on particles. Add variance to states.</li>
</ol>
<p><code>SensorModle.py</code>:</p>
<ol type="1">
<li>Precompute the sensor model table and use <a href="https://github.com/kctess5/range_libc" target="_blank" rel="noopener">range_libc</a> package to achieve 2D raycasting for 2D occupancy grid.</li>
<li>Subscribe to scan topic, filter out invalid and extreme scan values, downsample, and pass processed data to update weights.</li>
</ol>
<p><code>ParticleFilter.py</code>:</p>
<ol type="1">
<li>Transfer map to occupancy grid.</li>
<li>Globally initialize particles and weights. Initialize motion model and sensor model.</li>
<li>Subscribe to <code>/intialpose</code> topic, initialize particles and weights around initial pos.</li>
<li>When receiving scan infos, update weights, resample and calculate the expected pose for visualization.</li>
</ol>
<h1 id="lab2">Lab2</h1>
<table>
<thead>
<tr class="header">
<th style="text-align: center;"></th>
<th style="text-align: center;">Uses Model</th>
<th style="text-align: center;">Stability Guarantee</th>
<th style="text-align: center;">Minimize Cost</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">PID</td>
<td style="text-align: center;">No</td>
<td style="text-align: center;">No</td>
<td style="text-align: center;">No</td>
</tr>
<tr class="even">
<td style="text-align: center;">Pure Pursuit</td>
<td style="text-align: center;">Circular arcs</td>
<td style="text-align: center;">Yes - with assumptions</td>
<td style="text-align: center;">No</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Lyapunov</td>
<td style="text-align: center;">Non-linear</td>
<td style="text-align: center;">Yes</td>
<td style="text-align: center;">No</td>
</tr>
<tr class="even">
<td style="text-align: center;">LQR</td>
<td style="text-align: center;">Linear</td>
<td style="text-align: center;">Yes</td>
<td style="text-align: center;">Quadratic</td>
</tr>
<tr class="odd">
<td style="text-align: center;">iLQR</td>
<td style="text-align: center;">Non-linear</td>
<td style="text-align: center;">Yes</td>
<td style="text-align: center;">Yes</td>
</tr>
</tbody>
</table>
<h2 id="control">Control</h2>
<p><img src="https://codimd.s3.shivering-isles.com/demo/uploads/upload_026ce76324175dab1af828975d49d3bf.png" /></p>
<p>Position error in frame A: <span class="math display">\[
{}^{A}e = \begin{bmatrix}
x \\ y
\end{bmatrix} - \begin{bmatrix}
x_{ref} \\ y_{ref}
\end{bmatrix}
\]</span></p>
<p>We want position error in frame B so that <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> error correspond to along-track and cross-track error respectively: <span class="math display">\[
\begin{align*}
{}^{B}e &amp;= {}_A^{B} R {}^{A}e \\
&amp;=R(-\theta_{ref}) \left( \begin{bmatrix}
x \\ y
\end{bmatrix} - \begin{bmatrix}
x_{ref} \\ y_{ref}
\end{bmatrix} \right) \\
&amp;= \begin{bmatrix}
\cos \left(\theta_{r e f}\right)\left(x-x_{r e f}\right)+\sin \left(\theta_{r e f}\right)\left(y-y_{r e f}\right) \\
-\sin \left(\theta_{r e f}\right)\left(x-x_{r e f}\right)+\cos \left(\theta_{r e f}\right)\left(y-y_{r e f}\right)
\end{bmatrix} \\
&amp;= \begin{bmatrix}
e_{at} &amp; e_{ct}
\end{bmatrix}^T
\end{align*}
\]</span></p>
<p>Only consider cross-track error <span class="math inline">\(e_{ct}\)</span> and control steering angle for now.</p>
<h2 id="pid">PID</h2>
<p><span class="math display">\[
u=-\left(K_{p} e_{c t}+K_{i} \int e_{c t}(t) d t+K_{d} \dot{e}_{c t}\right)
\]</span></p>
<p>where</p>
<ul>
<li><span class="math inline">\(K_p\)</span>: Proportional coefficient</li>
<li><span class="math inline">\(K_i\)</span>: Integral coefficient</li>
<li><span class="math inline">\(K_d\)</span>: Derivative coefficient</li>
</ul>
<p>Analytically compute the derivative term: <span class="math display">\[
\begin{align*}
\dot{e}_{c t} &amp;=-\sin \left(\theta_{ref}\right) \dot{x}+\cos \left(\theta_{ref}\right) \dot{y} \\
&amp;=-\sin \left(\theta_{ref}\right) V \cos (\theta)+\cos \left(\theta_{ref}\right) V \sin (\theta) \\
&amp;=V \sin \left(\theta-\theta_{ref}\right) \\
&amp;=V \sin \left(\theta_{e}\right)
\end{align*}
\]</span></p>
<aside class="notice">
<ul>
<li>what if numerically compute the derivative term?</li>
<li>find example where Integral term is used. 通常用在有外力的情况? 比如要track的path是N极, 小车是S极(且<span class="math inline">\(K_p\)</span>项和外力抵消, 则无法消除<span class="math inline">\(e_{ct}\)</span>)</li>
<li>如果我们这个情况用<span class="math inline">\(K_I\)</span>会发生什么?一开始会收敛很快?通常会给积分项<span class="math inline">\(K_I\)</span>一个上限如果离reference path很远 是不是会在远处转圈圈?</li>
</ul>
</aside>
<h2 id="pure-pursuit">Pure-pursuit</h2>
<p><strong>Key idea</strong>: The car is always moving in a circular arc.</p>
<ol type="1">
<li>Find a lookahead and compute arc</li>
<li>Move along the arc</li>
<li>Go to step 1</li>
</ol>
<p>Solve for arc: <span class="math display">\[
\alpha=\tan ^{-1}\left(\frac{y_{ref}-y}{x_{ref}-x}\right)-\theta \\
R = \frac{L}{2 \sin\alpha} \\
\dot{\theta} = \frac{V}{R} = \frac{2V\sin\alpha}{L} \\
\dot{\theta} = \frac{V\tan u}{B}
\]</span></p>
<p>where <span class="math inline">\(B\)</span> is the car length. Solve for <span class="math inline">\(u\)</span> we can get <span class="math display">\[
u = \tan^{-1}\left( \frac{2B \sin \alpha}{L} \right)
\]</span></p>
<p><img src="https://codimd.s3.shivering-isles.com/demo/uploads/upload_9844cc32418a123e41c17e93270542ad.png" /></p>
<h2 id="lyapunov-control">Lyapunov control</h2>
<p>Define Lyapunov function: <span class="math display">\[
V\left(e_{ct}, \theta_{e}\right)=\frac{1}{2} k_{1} e_{ct}^{2}+\frac{1}{2} \theta_{e}^{2}
\]</span></p>
<p>Compute the derivative: <span class="math display">\[
\begin{align*}
\dot{V}\left(e_{c t}, \theta_{e}\right)&amp;=k_{1} e_{c t} \dot{e}_{c t}+\theta_{e} \dot{\theta}_{e}\\
&amp;=k_{1} e_{c t} V \sin \theta_{e}+\theta_{e} \frac{V}{B} \tan u
\end{align*}
\]</span></p>
<p>Set <span class="math inline">\(u\)</span> to get <span class="math inline">\(\dot{V} &lt; 0\)</span>: $$ <span class="math display">\[\begin{align}
\theta_{e} \frac{V}{B} \tan u
&amp;=-k_{1} e_{c t} V \sin \theta_{e}-k_{2} \theta_{e}^{2} \\

\tan u
&amp;=-\frac{k_{1} e_{c t} B}{\theta_{e}} \sin \theta_{e}-\frac{B}{V} k_{2} \theta_{e} \\

u
&amp;=\tan ^{-1}\left(-\frac{k_{1} e_{c t} B}{\theta_{e}} \sin \theta_{e}-\frac{B}{V} k_{2} \theta_{e}\right)
\end{align}\]</span> $$</p>
<h2 id="lqr">LQR</h2>
<p>Turn the problem into an optimization to trade-off both driving error and keeping control action small: <span class="math display">\[
\min _{u(t)} \int_{0}^{\infty}\left(w_{1} e(t)^{2}+w_{2} u(t)^{2} \right) dt
\]</span></p>
<p>Given</p>
<ol type="1">
<li><strong>Linear</strong> dynamic system <span class="math display">\[
  x_{t+1} = Ax_t + Bu_t
  \]</span></li>
<li><strong>Quadratic</strong> cost <span class="math display">\[
J=\sum_{t=0}^{T-1} x_{t}^{T} Q x_{t}+u_{t}^{T} R u_{t}
  \]</span></li>
</ol>
<p>The optimal control sequence minimizing the cost is $$ <span class="math display">\[\begin{align}
u_t 
&amp;= K_t x_t \\

K_{t}
&amp;=-\left(R+B^{T} V_{t+1} B\right)^{-1} B^{T} V_{t+1} A \\

V_{t}
&amp;=Q+K_{t}^{T} R K_{t}+\left(A+B K_{t}\right)^{T} V_{t+1}\left(A+B K_{t}\right)
\end{align}\]</span> $$</p>
<h2 id="mpc">MPC</h2>
<ol type="1">
<li>Plan a sequence of control actions</li>
<li>Predict the set of next states to a horizon H</li>
<li>Evaluate the cost/constraint of the states and controls</li>
<li>Optimize the cost</li>
</ol>
<aside class="notice">
<ul>
<li>主要就是error_cost + collision cost</li>
<li>如果error_cost 不用(x, y) Euclidian Distance, 而用CrossTrack Error会发生什么？会倒着走么？PID和PurePursuit呢?Lypunov呢?</li>
<li>能不能把reference path里面每个waypoints的顺序用起来解决这个问题呢. 比如删掉之前用过的reference pose?</li>
</ul>
</aside>
<h2 id="code-1">Code</h2>
<p><code>controlnode.py</code>: main script</p>
<ol type="1">
<li>Define Subscribers to pose and path infos; Publishers for visualization and Services for reset</li>
<li>Enter main program when initial pose is set and controller is ready. Get pose and reference pose, get next control and publish to <code>/vesc/high_level/ackermann_cmd_mux/input/nav_0</code> topic.</li>
<li>Stop when path is completed</li>
</ol>
<p><code>runner_script.py</code>:</p>
<ol type="1">
<li>Loading different paths and speed</li>
<li>Start the controller</li>
</ol>
<p><code>controller.py</code>: base controller class</p>
<ol type="1">
<li>Store path info</li>
<li>Define utility functions: get reference pose by index, get pose and pose_ref error</li>
</ol>
<p><mark>Find reference pose function is the same for all controllers: Find the nearest point on the path and lookahead some distance.</mark></p>
<p><code>pid.py</code>:</p>
<ol type="1">
<li>Use PD equation to get next control (steering angle)</li>
</ol>
<p><code>purepursuit.py</code>:</p>
<ol type="1">
<li>Use Purepursuit equation to get next control</li>
</ol>
<p><code>mpc.py</code>:</p>
<ol type="1">
<li>Dividing steering angle <span class="math inline">\([-\pi, \pi]\)</span> equally to <span class="math inline">\(K\)</span> rollouts</li>
<li>Execute each steering angel through <span class="math inline">\(T\)</span> timesteps to collect <span class="math inline">\(K * T\)</span> poses</li>
<li>Evaluate the cost of each rollout by collision cost and error cost
<ol type="1">
<li>Collision cost: if any pose in a trajectory is in collision with the map, add a large cost</li>
<li>Error cost: norm of the distance between last pose and the reference pose, weighted by a constant</li>
</ol></li>
<li>Choose the rollout with the minimal cost and execute the first step</li>
<li>Return to step 1</li>
</ol>
<p><code>mpc2.py</code>: Similar to mpc but use scan info rather than map. The only thing change is the obstacles cost.</p>
<ol type="1">
<li>Calculate <span class="math inline">\(N\)</span> obstacles pose in the map by scan info</li>
<li>For <span class="math inline">\(K * T\)</span> poses, calculate the distance with every obstacles to get <span class="math inline">\(K * T * N\)</span> array</li>
<li>Find the minimal distance for every pose to get <span class="math inline">\(K * T\)</span> array</li>
<li>Average through timesteps to get <span class="math inline">\(K\)</span> array, then weighted by a constant to get the obstacles cost.</li>
</ol>
<p><code>nonlinear.py</code>:</p>
<ol type="1">
<li>Use Lyapunov control equation to get the control</li>
</ol>
<h1 id="lab3">Lab3</h1>
<p>Steps for planing the path from one point to another:</p>
<ol type="1">
<li>Random sample points on the map and construct the graph</li>
<li>Use planning algorithm (A*) to search the graph for optimal path</li>
</ol>
<h2 id="graph-construction">Graph construction</h2>
<p>The graph we are constructing is called <a href="https://en.wikipedia.org/wiki/Random_geometric_graph" target="_blank" rel="noopener">Random geometric graph</a> (RGG)</p>
<ol type="1">
<li>Sample a set of collision free vertices <span class="math inline">\(V\)</span></li>
<li>Connect neighboring vertices to get edges <span class="math inline">\(E\)</span></li>
</ol>
<h3 id="sampling">sampling</h3>
<p>Uniform random sampling tends to clump. We want points to be spread out evenly, which can be achieved by <a href="https://observablehq.com/@jrus/halton" target="_blank" rel="noopener">Halton sequence</a></p>
<h3 id="optimal-radius">optimal radius</h3>
<p>We want to choose the radius smaller enough for efficiency while ensuring connectivity. The optimal value can be chosen as <span class="math display">\[
r = \left(\frac{\ln|V|}{\alpha_{p,d} |V|}\right)^{1/n}
\]</span> where <span class="math inline">\(\alpha_{p,d}\)</span> is a constant. For special case of a two-dimensional space and the euclidean norm (<span class="math inline">\(d=2\)</span>, <span class="math inline">\(p=2\)</span>), <span class="math inline">\(\alpha_{p,d} = \pi\)</span></p>
<h3 id="dubins-path">Dubins path</h3>
<p>Since we are considering 2-D car dynamics, we need to connect two points with feasible path instead of straight lines. Mathematically, we need to solve the BVP: <span class="math display">\[
\dot{q}(t) = f(q(t), u(t)) \\
q(0) = q_1,\quad q(t) = q_2
\]</span> where <span class="math inline">\(q=(x,y,\theta)\)</span> in our case.</p>
<p>Dubins path shows that the solution always exists and has to be one of 6 classes: <span class="math display">\[
\{LRL, RLR, LSL, LSR, RSL, RSR\}
\]</span> where <span class="math inline">\(L,R,S\)</span> represent turn left, right, straight, respectively.</p>
<h2 id="planning-algorithm">Planning algorithm</h2>
<p>Given start node <span class="math inline">\(s_0\)</span>, goal <span class="math inline">\(s_1\)</span> and cost <span class="math inline">\(c(s, s&#39;)\)</span>, create objects:</p>
<ol type="1">
<li>OPEN: <strong>priority queue</strong> of nodes to be processed</li>
<li>CLOSED: list of nodes already processed</li>
<li><span class="math inline">\(g(s)\)</span>: estimate of the least cost from start to a given node</li>
</ol>
<p>The pseudocode for <strong>best first search</strong> can be expressed as</p>
<ol type="1">
<li><p>Push <span class="math inline">\(s_0\)</span> into OPEN</p></li>
<li><p>While <span class="math inline">\(s_1\)</span> not expanded</p>
<ol start="3" type="1">
<li><p>Pop <em>best</em> from OPEN</p></li>
<li><p>Add <em>best</em> to CLOSED</p></li>
<li><p>For every successor <em>s'</em></p>
<ol start="6" type="1">
<li>If <span class="math inline">\(g(s&#39;) &gt; g(s) + c(s, s&#39;)\)</span>
<ol start="7" type="1">
<li><span class="math inline">\(g(s&#39;) = g(s) + c(s, s&#39;)\)</span></li>
<li>Add (update) <span class="math inline">\(s&#39;\)</span> to OPEN</li>
</ol></li>
</ol></li>
</ol></li>
</ol>
<p>The main problem is how to choose the heuristic function <span class="math inline">\(f(s)\)</span> for step 3.</p>
<h3 id="djikstras-algorithm">Djikstra's algorithm</h3>
<p>Choose <span class="math inline">\(f(s) = g(s)\)</span>. Always pop the node with the smallest cost from the origin first.</p>
<h3 id="a">A*</h3>
<p><mark>看看这个<a href="http://theory.stanford.edu/~amitp/GameProgramming/AStarComparison.html" target="_blank" rel="noopener">astar</a></mark></p>
<p>If we can pre-evaluate the cost from the node to the goal <span class="math inline">\(h(s)\)</span>, then we can choose a better <span class="math inline">\(f(s) = g(s) + h(s)\)</span>.</p>
<ul>
<li>If <span class="math inline">\(h(s)\)</span> is admissible <span class="math inline">\(h(s) \le h^*(s)\)</span>, <span class="math inline">\(h(goal) = 0\)</span>, then the path return by A* is optimal.</li>
<li>If <span class="math inline">\(h(s)\)</span> is consistent <span class="math inline">\(h(s) \le c(s, s&#39;) + h(s&#39;)\)</span>, <span class="math inline">\(h(goal) = 0\)</span>, then A* is optimal and efficient (will not re-expand a node).</li>
</ul>
<p>All consistent heuristics are admissible, not vice versa.</p>
<h3 id="weighted-a">weighted A*</h3>
<p>Choose <span class="math inline">\(f(s) = g(s) + \epsilon h(s)\)</span>, where <span class="math inline">\(\epsilon &gt; 1\)</span>. It is more efficient and the solution is <span class="math inline">\(\epsilon\)</span>-optimal <span class="math inline">\(c \le \epsilon c^*\)</span></p>
<h3 id="lazy-a">lazy A*</h3>
<p>Instead of checking edge collision for all neighbors, only check the edge to parent when expanding. <mark>OPEN list will have multiple copies of a node since we haven't collision check.</mark></p>
<h3 id="shortcut">shortcut</h3>
<p>After a path is found, we can randomly pick two nodes and connect them directly if the edge is collision-free.</p>
<h2 id="code-2">Code</h2>
<p><code>run.py</code>: main program</p>
<ol type="1">
<li>Load map info</li>
<li>Construct graph given environment, sampler, number of vertices, connection radius.</li>
<li>Add start and end node</li>
<li>Use A* or lazy A* algorithm to search the optimal path and visualize</li>
</ol>
<p><code>MapEnvironment.py</code>: define utility functions associated with planning</p>
<ol type="1">
<li>Check edge collision</li>
<li>Compute heuristic and distance function</li>
<li>Generate path on the map</li>
<li>Visualization of the graph and path</li>
</ol>
<p><code>Sampler.py</code>: create random samples for graph construction</p>
<ol type="1">
<li>Use <a href="https://gist.github.com/tupui/cea0a91cc127ea3890ac0f002f887bae" target="_blank" rel="noopener">halton sequence</a> to generate 2-D random vertices in <span class="math inline">\((0,1)\)</span></li>
<li>Scale by map info</li>
</ol>
<p><code>graph_maker.py</code>: construct graph</p>
<ol type="1">
<li>Use python package <a href="https://networkx.github.io/" target="_blank" rel="noopener">NetworkX</a> to easily construct a graph</li>
<li>Add sampled valid vertices</li>
<li>Connect edges within radius and without collision (do not check collision if using lazy A*)</li>
</ol>
<p><code>astar.py</code>: A* algorithm</p>
<ol type="1">
<li>Use <code>heapq</code> package to create priority queue to store <code>[f(s), count, node, g(s), parent]</code> info. <code>count</code> is used to prevent comparing node when <span class="math inline">\(f(s)\)</span> are the same.</li>
<li>Use dict <code>enqueued</code> to store <span class="math inline">\(g(s)\)</span> and <span class="math inline">\(h(s)\)</span> for a node, and another dict <code>explored</code> to store the explored node and its parent node.</li>
<li>Add start node to the queue.</li>
<li>While queue is not empty, pop one node and add it to <code>explored</code> if it is not already there.</li>
<li>For all the neighbor node <span class="math inline">\(s&#39;\)</span>, compute <span class="math inline">\(g(s&#39;) = g(s) + c(s,s&#39;)\)</span> if <span class="math inline">\(s&#39;\)</span> is not already in <code>explored</code>.</li>
<li>If <span class="math inline">\(s&#39;\)</span> is in <code>enqueued</code>, get its previous <span class="math inline">\(g&#39;(s&#39;)\)</span> and <span class="math inline">\(h&#39;(s&#39;)\)</span>. Continue to next neighbor if <span class="math inline">\(g&#39;(s) \le g(s&#39;)\)</span>, since it is better. If not in <code>enqueued</code>, compute <span class="math inline">\(h(s&#39;)\)</span> by the heuristic function.</li>
<li>Update <span class="math inline">\(g(s&#39;)\)</span> and <span class="math inline">\(h(s&#39;)\)</span> in <code>enqueued</code> and push it to the queue.</li>
<li>If reach target node, continually find parent node by <code>explored</code> and return the path.</li>
</ol>
<p><code>lazy_astar.py</code>: lazy A* algorithm</p>
<ol type="1">
<li>When expanding node, check its edge collision with parent.</li>
<li>When checking neighbors, do not need to compare <span class="math inline">\(g&#39;(s&#39;)\)</span> and <span class="math inline">\(g(s&#39;)\)</span></li>
<li>Multiple nodes with different parents can be added to the queue.</li>
</ol>
<p><code>runDubins.py</code>: similar to <code>run.py</code> but use Dubins environment</p>
<p><code>DubinsMapEnvironment.py</code>: inherited from <code>MapEnvironment</code></p>
<ol type="1">
<li>Compute distances with Dubins path</li>
<li>Compute heuristic with Dubins path</li>
<li>Generate path by Dubins path planning</li>
</ol>
<p><code>DubinsSampler.py</code>:</p>
<ol type="1">
<li>Sample <span class="math inline">\(N\)</span> vertices same as in <code>Sampler.py</code></li>
<li>Divide angles to <span class="math inline">\(M\)</span> parts, add angles to each vertices to create <span class="math inline">\(M\times N\)</span> samples</li>
</ol>
<p><code>Dubins.py</code>: utility function for Dubins path</p>
<p><code>ROSPlanner.py</code>: take goal from rviz and do planning. <mark>Be careful of the frame change between map and world</mark></p>
<ol type="1">
<li>Load map info</li>
<li>Construct graph and save for later use</li>
<li>Subscribe to pose topic, save current pose</li>
<li>Subscribe to goal topic, plan from the current pose to the goal, publish the path using service defined in lab2</li>
<li>If there are multiple goals, sequentially planning through them and combine the path</li>
</ol>
<h1 id="reference">Reference</h1>
<ol type="1">
<li><a href="http://ais.informatik.uni-freiburg.de/teaching/ss13/robotics/" target="_blank" rel="noopener">Introduction to Mobile Robotics</a></li>
<li><a href="https://courses.cs.washington.edu/courses/cse490r/19sp/" target="_blank" rel="noopener">Mobile Robots</a></li>
<li><a href="http://www.probabilistic-robotics.org/" target="_blank" rel="noopener">Probabilistic Robotics</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://thesong96.github.io/2020/03/08/Python-Comments-Style/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/baby.png">
      <meta itemprop="name" content="Nansong Yi">
      <meta itemprop="description" content="TheSong is named after IG.TheShy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TheSong">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/08/Python-Comments-Style/" class="post-title-link" itemprop="url">Python Comments Style</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-08 22:21:41" itemprop="dateCreated datePublished" datetime="2020-03-08T22:21:41-07:00">2020-03-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-07 19:46:20" itemprop="dateModified" datetime="2020-10-07T19:46:20-07:00">2020-10-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Misc/" itemprop="url" rel="index"><span itemprop="name">Misc</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="google-style">Google Style</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""Example Google style docstrings.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This module demonstrates documentation as specified by the `Google Python</span></span><br><span class="line"><span class="string">Style Guide`_. Docstrings may extend over multiple lines. Sections are created</span></span><br><span class="line"><span class="string">with a section header and a colon followed by a block of indented text.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Example:</span></span><br><span class="line"><span class="string">    Examples can be given using either the ``Example`` or ``Examples``</span></span><br><span class="line"><span class="string">    sections. Sections support any reStructuredText formatting, including</span></span><br><span class="line"><span class="string">    literal blocks::</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        $ python example_google.py</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Section breaks are created by resuming unindented text. Section breaks</span></span><br><span class="line"><span class="string">are also implicitly created anytime a new section starts.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Attributes:</span></span><br><span class="line"><span class="string">    module_level_variable1 (int): Module level variables may be documented in</span></span><br><span class="line"><span class="string">        either the ``Attributes`` section of the module docstring, or in an</span></span><br><span class="line"><span class="string">        inline docstring immediately following the variable.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Either form is acceptable, but the two should not be mixed. Choose</span></span><br><span class="line"><span class="string">        one convention to document module level variables and be consistent</span></span><br><span class="line"><span class="string">        with it.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Todo:</span></span><br><span class="line"><span class="string">    * For module TODOs</span></span><br><span class="line"><span class="string">    * You have to also use ``sphinx.ext.todo`` extension</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">.. _Google Python Style Guide:</span></span><br><span class="line"><span class="string">   http://google.github.io/styleguide/pyguide.html</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">module_level_variable1 = <span class="number">12345</span></span><br><span class="line"></span><br><span class="line">module_level_variable2 = <span class="number">98765</span></span><br><span class="line"><span class="string">"""int: Module level variable documented inline.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The docstring may span multiple lines. The type may optionally be specified</span></span><br><span class="line"><span class="string">on the first line, separated by a colon.</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">function_with_types_in_docstring</span><span class="params">(param1, param2)</span>:</span></span><br><span class="line">    <span class="string">"""Example function with types documented in the docstring.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    `PEP 484`_ type annotations are supported. If attribute, parameter, and</span></span><br><span class="line"><span class="string">    return types are annotated according to `PEP 484`_, they do not need to be</span></span><br><span class="line"><span class="string">    included in the docstring:</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        param1 (int): The first parameter.</span></span><br><span class="line"><span class="string">        param2 (str): The second parameter.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        bool: The return value. True for success, False otherwise.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    .. _PEP 484:</span></span><br><span class="line"><span class="string">        https://www.python.org/dev/peps/pep-0484/</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">function_with_pep484_type_annotations</span><span class="params">(param1: int, param2: str)</span> -&gt; bool:</span></span><br><span class="line">    <span class="string">"""Example function with PEP 484 type annotations.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        param1: The first parameter.</span></span><br><span class="line"><span class="string">        param2: The second parameter.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        The return value. True for success, False otherwise.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">module_level_function</span><span class="params">(param1, param2=None, *args, **kwargs)</span>:</span></span><br><span class="line">    <span class="string">"""This is an example of a module level function.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Function parameters should be documented in the ``Args`` section. The name</span></span><br><span class="line"><span class="string">    of each parameter is required. The type and description of each parameter</span></span><br><span class="line"><span class="string">    is optional, but should be included if not obvious.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    If \*args or \*\*kwargs are accepted,</span></span><br><span class="line"><span class="string">    they should be listed as ``*args`` and ``**kwargs``.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    The format for a parameter is::</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        name (type): description</span></span><br><span class="line"><span class="string">            The description may span multiple lines. Following</span></span><br><span class="line"><span class="string">            lines should be indented. The "(type)" is optional.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">            Multiple paragraphs are supported in parameter</span></span><br><span class="line"><span class="string">            descriptions.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        param1 (int): The first parameter.</span></span><br><span class="line"><span class="string">        param2 (:obj:`str`, optional): The second parameter. Defaults to None.</span></span><br><span class="line"><span class="string">            Second line of description should be indented.</span></span><br><span class="line"><span class="string">        *args: Variable length argument list.</span></span><br><span class="line"><span class="string">        **kwargs: Arbitrary keyword arguments.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        bool: True if successful, False otherwise.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        The return type is optional and may be specified at the beginning of</span></span><br><span class="line"><span class="string">        the ``Returns`` section followed by a colon.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        The ``Returns`` section may span multiple lines and paragraphs.</span></span><br><span class="line"><span class="string">        Following lines should be indented to match the first line.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        The ``Returns`` section supports any reStructuredText formatting,</span></span><br><span class="line"><span class="string">        including literal blocks::</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                'param1': param1,</span></span><br><span class="line"><span class="string">                'param2': param2</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Raises:</span></span><br><span class="line"><span class="string">        AttributeError: The ``Raises`` section is a list of all exceptions</span></span><br><span class="line"><span class="string">            that are relevant to the interface.</span></span><br><span class="line"><span class="string">        ValueError: If `param2` is equal to `param1`.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> param1 == param2:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">'param1 may not be equal to param2'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">example_generator</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="string">"""Generators have a ``Yields`` section instead of a ``Returns`` section.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        n (int): The upper limit of the range to generate, from 0 to `n` - 1.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Yields:</span></span><br><span class="line"><span class="string">        int: The next number in the range of 0 to `n` - 1.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Examples:</span></span><br><span class="line"><span class="string">        Examples should be written in doctest format, and should illustrate how</span></span><br><span class="line"><span class="string">        to use the function.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; print([i for i in example_generator(4)])</span></span><br><span class="line"><span class="string">        [0, 1, 2, 3]</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleError</span><span class="params">(Exception)</span>:</span></span><br><span class="line">    <span class="string">"""Exceptions are documented in the same way as classes.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The __init__ method may be documented in either the class level</span></span><br><span class="line"><span class="string">    docstring, or as a docstring on the __init__ method itself.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Either form is acceptable, but the two should not be mixed. Choose one</span></span><br><span class="line"><span class="string">    convention to document the __init__ method and be consistent with it.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Note:</span></span><br><span class="line"><span class="string">        Do not include the `self` parameter in the ``Args`` section.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        msg (str): Human readable string describing the exception.</span></span><br><span class="line"><span class="string">        code (:obj:`int`, optional): Error code.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Attributes:</span></span><br><span class="line"><span class="string">        msg (str): Human readable string describing the exception.</span></span><br><span class="line"><span class="string">        code (int): Exception error code.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, msg, code)</span>:</span></span><br><span class="line">        self.msg = msg</span><br><span class="line">        self.code = code</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleClass</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""The summary line for a class docstring should fit on one line.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    If the class has public attributes, they may be documented here</span></span><br><span class="line"><span class="string">    in an ``Attributes`` section and follow the same formatting as a</span></span><br><span class="line"><span class="string">    function's ``Args`` section. Alternatively, attributes may be documented</span></span><br><span class="line"><span class="string">    inline with the attribute's declaration (see __init__ method below).</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Properties created with the ``@property`` decorator should be documented</span></span><br><span class="line"><span class="string">    in the property's getter method.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Attributes:</span></span><br><span class="line"><span class="string">        attr1 (str): Description of `attr1`.</span></span><br><span class="line"><span class="string">        attr2 (:obj:`int`, optional): Description of `attr2`.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, param1, param2, param3)</span>:</span></span><br><span class="line">        <span class="string">"""Example of docstring on the __init__ method.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        The __init__ method may be documented in either the class level</span></span><br><span class="line"><span class="string">        docstring, or as a docstring on the __init__ method itself.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        Either form is acceptable, but the two should not be mixed. Choose one</span></span><br><span class="line"><span class="string">        convention to document the __init__ method and be consistent with it.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        Note:</span></span><br><span class="line"><span class="string">            Do not include the `self` parameter in the ``Args`` section.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            param1 (str): Description of `param1`.</span></span><br><span class="line"><span class="string">            param2 (:obj:`int`, optional): Description of `param2`. Multiple</span></span><br><span class="line"><span class="string">                lines are supported.</span></span><br><span class="line"><span class="string">            param3 (:obj:`list` of :obj:`str`): Description of `param3`.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.attr1 = param1</span><br><span class="line">        self.attr2 = param2</span><br><span class="line">        self.attr3 = param3  <span class="comment">#: Doc comment *inline* with attribute</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">#: list of str: Doc comment *before* attribute, with type specified</span></span><br><span class="line">        self.attr4 = [<span class="string">'attr4'</span>]</span><br><span class="line">    </span><br><span class="line">        self.attr5 = <span class="literal">None</span></span><br><span class="line">        <span class="string">"""str: Docstring *after* attribute, with type specified."""</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">readonly_property</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""str: Properties should be documented in their getter method."""</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'readonly_property'</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">readwrite_property</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">""":obj:`list` of :obj:`str`: Properties with both a getter and setter</span></span><br><span class="line"><span class="string">        should only be documented in their getter method.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        If the setter method contains notable behavior, it should be</span></span><br><span class="line"><span class="string">        mentioned here.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> [<span class="string">'readwrite_property'</span>]</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @readwrite_property.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">readwrite_property</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        value</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">example_method</span><span class="params">(self, param1, param2)</span>:</span></span><br><span class="line">        <span class="string">"""Class methods are similar to regular functions.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        Note:</span></span><br><span class="line"><span class="string">            Do not include the `self` parameter in the ``Args`` section.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            param1: The first parameter.</span></span><br><span class="line"><span class="string">            param2: The second parameter.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            True if successful, False otherwise.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__special__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""By default special members with docstrings are not included.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        Special members are any methods or attributes that start with and</span></span><br><span class="line"><span class="string">        end with a double underscore. Any special member with a docstring</span></span><br><span class="line"><span class="string">        will be included in the output, if</span></span><br><span class="line"><span class="string">        ``napoleon_include_special_with_doc`` is set to True.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        This behavior can be enabled by changing the following setting in</span></span><br><span class="line"><span class="string">        Sphinx's conf.py::</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">            napoleon_include_special_with_doc = True</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__special_without_docstring__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_private</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""By default private members are not included.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        Private members are any methods or attributes that start with an</span></span><br><span class="line"><span class="string">        underscore and are *not* special. By default they are not included</span></span><br><span class="line"><span class="string">        in the output.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        This behavior can be changed such that private members *are* included</span></span><br><span class="line"><span class="string">        by changing the following setting in Sphinx's conf.py::</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">            napoleon_include_private_with_doc = True</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_private_without_docstring</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://thesong96.github.io/2020/02/28/Review-Transfer-depends-on-Acquisition-Analyzing-Manipulation-Strategies/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/baby.png">
      <meta itemprop="name" content="Nansong Yi">
      <meta itemprop="description" content="TheSong is named after IG.TheShy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TheSong">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/28/Review-Transfer-depends-on-Acquisition-Analyzing-Manipulation-Strategies/" class="post-title-link" itemprop="url">Review - Transfer depends on Acquisition: Analyzing Manipulation Strategies for Robotic Feeding</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-28 15:17:42" itemprop="dateCreated datePublished" datetime="2020-02-28T15:17:42-08:00">2020-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-04 16:29:57" itemprop="dateModified" datetime="2020-03-04T16:29:57-08:00">2020-03-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PRL/" itemprop="url" rel="index"><span itemprop="name">PRL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Goal</strong>:</p>
<ul>
<li>review SPNet
<ul>
<li>Dense Block需要搞明白.</li>
</ul></li>
<li>What is BLD ??????</li>
<li>review dataset</li>
</ul>
<hr />
<h3 id="spnet">SPNet</h3>
<p>Skewering Position Network</p>
<figure>
<img src="https://i.imgur.com/4HVZJjk.png" alt="spnet" /><figcaption aria-hidden="true">spnet</figcaption>
</figure>
<ul>
<li>Dense Block? we have two version of SPNet (shallow/dense). A shallower version() has 3 and 6 inner layers in each dense block and a deeper version has 6 and 12 inner layers respectively.</li>
<li>We tested multiple versions of SPNet with varying dense block sizes and angle resolutions. All the network variants including the simple SPNet were trained with the dataset until the training loss stabilized, and for the binary masks, they reached a similar test accuracy of 96.5%. However, the <code>F1 score</code> of the dense block SPNet was 11.76% higher than the simple SPNet. The <code>recall</code> of the dense block SPNet was higher than that of the simple SPNet while their precisions were similar.
<ul>
<li>what's the difference between simple and dense block SPNet?</li>
<li>recap criteria: F1 score, recall, true positive, false negative, etc</li>
</ul></li>
<li>Rotation Mask, according to the tutorial script, pred_rmasks.shape = (1, 289, 19) why 19?</li>
<li>The rotation mask consists of 17 × 17 × a grid cells, where a is the angle resolution represented by the number of classes for the discretized angles between [0, π).</li>
<li>why discretized angles to <code>#a</code> classes:
<ul>
<li>the rotation classification was more reliable than rotation regression for our early test cases.</li>
<li>we can handle the rotation free annotation as a class among other specific rotations.
<ul>
<li>(rotation free? means any rotation is ok for that food item, according to the note below)</li>
</ul></li>
<li>here, we set angle resolution to be 18, there are a total of 19 classes: class 0 represents any rotation while class 1 ∼ 18 denote specific angles, <span class="math inline">\((class id−1)×10°\)</span>. `````````````````</li>
</ul></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> bite_selection_package.model.spnet <span class="keyword">import</span> DenseSPNet</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spnet_tutorial</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># initialize DenseSPNet and load the trained checkpoint</span></span><br><span class="line">    spnet = DenseSPNet()</span><br><span class="line">    checkpoint = torch.load(<span class="string">'../checkpoint/spnet_ckpt.pth'</span>)</span><br><span class="line">    spnet.load_state_dict(checkpoint[<span class="string">'net'</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># prepare an input image</span></span><br><span class="line">    img = Image.open(<span class="string">'./sample.jpg'</span>)</span><br><span class="line">    img = img.resize((<span class="number">136</span>, <span class="number">136</span>))</span><br><span class="line">    trans = transforms.ToTensor()</span><br><span class="line">    inp = torch.stack([trans(img)])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get predictions</span></span><br><span class="line">    spnet.eval()</span><br><span class="line">    pred_bmasks, pred_rmasks = spnet(inp)</span><br><span class="line"></span><br><span class="line">    print(pred_bmasks.shape, pred_rmasks.shape)</span><br><span class="line">    <span class="comment"># print and visualize predicted masks</span></span><br><span class="line">    print(<span class="string">'rotation mask: '</span>)</span><br><span class="line">    print(pred_rmasks.data)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'visualize binary mask for skewering locations'</span>)</span><br><span class="line">    bm_arr = pred_bmasks.data[<span class="number">0</span>].sigmoid().view(<span class="number">17</span>, <span class="number">17</span>).numpy()</span><br><span class="line"></span><br><span class="line">    print(bm_arr.shape)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    spnet_tutorial()</span><br></pre></td></tr></table></figure>
<ul>
<li>why not <code>Mask-RCNN</code>: We developed SPNet running on top of RetinaNet instead of extending Mask RCNN because we do not need pixel-wise mask generation and masks over the entire input scene – SPNet runs only for the food item we want to acquire.</li>
<li>why dense block: we adopt the dense block structure from <code>DenseNet</code> in order to increase the representation power of the network.</li>
</ul>
<h3 id="dataset">DataSet</h3>
<figure>
<img src="https://i.imgur.com/J0KEEId.png" alt="SPNet prformance" /><figcaption aria-hidden="true">SPNet prformance</figcaption>
</figure>
<ul>
<li><p>small: Cantaloupes, bananas, and strawberries</p>
<p>long: carrots and celeries</p>
<p>round: eggs</p>
<p>We generated the masks with specific rules for each category for effective feeding, so that SPNet learns our category-dependent strategies (see Fig.4), like skewering long items at their ends with the tines perpendicular(fork tine?? 怎么个垂直，是fork的切面?) to the item’s long axis.</p></li>
</ul>
<h3 id="bite-acquisition-experiments">Bite Acquisition Experiments</h3>
<ul>
<li><p>Using each of these strategies, ourautonomous robotic system skewered 2 plates of 5 pieces of each of these 6 food items, thus totalling to 3 skewering position strategies × 2 plates × 5 pieces × 6 food items = 180 trials. <strong>Since both the baseline and SPNet methods are capable of letting the user select the food item to acquire, our system attempted skewering each item only once</strong>. This is in contrast to BLD, which doesn’t let the user choose and thus is free to retry food items. We restrict BLD to 30 attempts to match the number of trials used for the other methods</p></li>
<li><p><strong>check the experiment video to see how exactly we do it</strong>.</p>
<p>For two of the food items, bananas, and strawberries, we also compared two skewering approach angle strategies: <em>vertical and angled</em>. We had two discrete manipulation primitives for the angled primitive, one with horizontal tines and one with vertical. Bananas often slip off the fork, so we tilted the fork by 45 degrees to orient the tines more horizontally. When skewering strawberries, the tines tend to slip on the rounded surface without penetrating it. Therefore, we tilted the fork in the other direction to so that the tines skewered the strawberry vertically. Using SPNet, we skewered 2 plates of 5 items for bananas and strawberries, resulting in 20 additional trials which we compared with the vertical performance of the above experiment.<img src="https://i.imgur.com/zb9XuEk.jpg" alt="image-20200304155034047" /></p></li>
<li></li>
</ul>
<hr />
<p><strong>憨憨学英语</strong>🌲</p>
<ul>
<li>Heterogeneous 异构的</li>
<li>slender 苗条的</li>
<li>yolk 蛋黄</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Nansong Yi"
      src="/images/baby.png">
  <p class="site-author-name" itemprop="name">Nansong Yi</p>
  <div class="site-description" itemprop="description">TheSong is named after IG.TheShy</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">14</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/nansongyi" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;nansongyi" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:nansong@uw.edu" title="E-Mail → mailto:nansong@uw.edu" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://nansongyi.me/" title="http:&#x2F;&#x2F;nansongyi.me" rel="noopener" target="_blank">my web</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://silencial.github.io/" title="https:&#x2F;&#x2F;silencial.github.io&#x2F;" rel="noopener" target="_blank">silencial</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://3monks.org/en/" title="https:&#x2F;&#x2F;3monks.org&#x2F;en&#x2F;" rel="noopener" target="_blank">sky</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.twistedwg.com/pages/class.html" title="http:&#x2F;&#x2F;www.twistedwg.com&#x2F;pages&#x2F;class.html" rel="noopener" target="_blank">twistedwg</a>
        </li>
    </ul>
  </div>

      </div>
      <!--
      <div style="position:absolute; bottom:120px left:auto; width:85%">
          <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=450 src="//music.163.com/outchain/player?type=0&id=5290225297&auto=1&height=430"></iframe>
      </div>
      -->

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Nansong Yi</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














    <div id="pjax">
  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

    </div>
</body>
</html>
